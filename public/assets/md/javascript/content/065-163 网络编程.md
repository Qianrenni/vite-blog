## 16.3 网络编程

### HTTP 服务器创建

**基础 HTTP 服务器：**
```javascript
const http = require('http');
const url = require('url');
const querystring = require('querystring');

// 创建 HTTP 服务器
const server = http.createServer((req, res) => {
    const parsedUrl = url.parse(req.url, true);
    const pathname = parsedUrl.pathname;
    const query = parsedUrl.query;
    const method = req.method;
    
    // 设置 CORS 头
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
    
    // 处理预检请求
    if (method === 'OPTIONS') {
        res.writeHead(200);
        res.end();
        return;
    }
    
    // 路由处理
    if (pathname === '/api/users' && method === 'GET') {
        handleGetUsers(req, res, query);
    } else if (pathname === '/api/users' && method === 'POST') {
        handleCreateUser(req, res);
    } else if (pathname.startsWith('/api/users/') && method === 'GET') {
        const userId = pathname.split('/')[3];
        handleGetUser(req, res, userId);
    } else if (pathname === '/upload' && method === 'POST') {
        handleFileUpload(req, res);
    } else {
        res.writeHead(404, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: 'Not Found' }));
    }
});

// 处理 GET /api/users
function handleGetUsers(req, res, query) {
    const users = [
        { id: 1, name: 'Alice', email: 'alice@example.com' },
        { id: 2, name: 'Bob', email: 'bob@example.com' }
    ];
    
    // 支持分页和过滤
    const page = parseInt(query.page) || 1;
    const limit = parseInt(query.limit) || 10;
    const offset = (page - 1) * limit;
    
    const filteredUsers = users.slice(offset, offset + limit);
    
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({
        data: filteredUsers,
        pagination: {
            page,
            limit,
            total: users.length
        }
    }));
}

// 处理 POST /api/users
function handleCreateUser(req, res) {
    let body = '';
    
    req.on('data', chunk => {
        body += chunk.toString();
    });
    
    req.on('end', () => {
        try {
            const userData = JSON.parse(body);
            
            // 验证数据
            if (!userData.name || !userData.email) {
                res.writeHead(400, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({ error: 'Name and email are required' }));
                return;
            }
            
            // 创建用户（模拟）
            const newUser = {
                id: Date.now(),
                ...userData,
                createdAt: new Date().toISOString()
            };
            
            res.writeHead(201, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify(newUser));
        } catch (error) {
            res.writeHead(400, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ error: 'Invalid JSON' }));
        }
    });
}

// 处理 GET /api/users/:id
function handleGetUser(req, res, userId) {
    const user = { id: userId, name: 'User Name', email: 'user@example.com' };
    
    if (!user) {
        res.writeHead(404, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: 'User not found' }));
        return;
    }
    
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify(user));
}

// 处理文件上传
function handleFileUpload(req, res) {
    const contentType = req.headers['content-type'];
    
    if (!contentType || !contentType.includes('multipart/form-data')) {
        res.writeHead(400, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: 'Content-Type must be multipart/form-data' }));
        return;
    }
    
    let body = '';
    
    req.on('data', chunk => {
        body += chunk.toString();
    });
    
    req.on('end', () => {
        // 这里应该解析 multipart 数据
        // 实际应用中建议使用 multer 等库
        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ 
            message: 'File uploaded successfully',
            size: body.length 
        }));
    });
}

// 服务器配置
server.on('clientError', (err, socket) => {
    socket.end('HTTP/1.1 400 Bad Request\r\n\r\n');
});

server.listen(3000, () => {
    console.log('服务器运行在 http://localhost:3000');
});

// 优雅关闭
process.on('SIGTERM', () => {
    console.log('接收到 SIGTERM 信号，正在关闭服务器...');
    server.close(() => {
        console.log('服务器已关闭');
        process.exit(0);
    });
});
```

### WebSocket 实时通信

**WebSocket 服务器：**
```javascript
const WebSocket = require('ws');
const http = require('http');

// 创建 HTTP 服务器
const server = http.createServer((req, res) => {
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    res.end('WebSocket Server');
});

// 创建 WebSocket 服务器
const wss = new WebSocket.Server({ server });

// 存储连接的客户端
const clients = new Set();

// 处理新连接
wss.on('connection', (ws, req) => {
    console.log('新的 WebSocket 连接');
    
    // 添加客户端到集合
    clients.add(ws);
    
    // 发送欢迎消息
    ws.send(JSON.stringify({
        type: 'welcome',
        message: '连接成功',
        timestamp: Date.now()
    }));
    
    // 处理消息
    ws.on('message', (message) => {
        try {
            const data = JSON.parse(message);
            handleWebSocketMessage(ws, data);
        } catch (error) {
            console.error('消息解析错误:', error);
            ws.send(JSON.stringify({
                type: 'error',
                message: 'Invalid message format'
            }));
        }
    });
    
    // 处理连接关闭
    ws.on('close', () => {
        console.log('WebSocket 连接关闭');
        clients.delete(ws);
        broadcast({
            type: 'user_left',
            timestamp: Date.now()
        });
    });
    
    // 处理错误
    ws.on('error', (error) => {
        console.error('WebSocket 错误:', error);
        clients.delete(ws);
    });
    
    // 通知其他用户有新用户加入
    broadcast({
        type: 'user_joined',
        timestamp: Date.now()
    });
});

// 处理 WebSocket 消息
function handleWebSocketMessage(ws, data) {
    switch (data.type) {
        case 'chat_message':
            // 广播聊天消息
            broadcast({
                type: 'chat_message',
                user: data.user,
                message: data.message,
                timestamp: Date.now()
            }, ws); // 排除发送者
            break;
            
        case 'typing':
            // 广播打字状态
            broadcast({
                type: 'typing',
                user: data.user,
                typing: data.typing
            }, ws);
            break;
            
        case 'ping':
            // 回复 pong
            ws.send(JSON.stringify({
                type: 'pong',
                timestamp: Date.now()
            }));
            break;
            
        default:
            ws.send(JSON.stringify({
                type: 'error',
                message: 'Unknown message type'
            }));
    }
}

// 广播消息给所有客户端
function broadcast(message, excludeClient = null) {
    const messageString = JSON.stringify(message);
    
    clients.forEach(client => {
        if (client !== excludeClient && client.readyState === WebSocket.OPEN) {
            client.send(messageString);
        }
    });
}

// 定期发送心跳
setInterval(() => {
    broadcast({
        type: 'heartbeat',
        timestamp: Date.now()
    });
}, 30000);

// 启动服务器
server.listen(8080, () => {
    console.log('WebSocket 服务器运行在 ws://localhost:8080');
});
```

**WebSocket 客户端示例：**
```javascript
// client.js
const WebSocket = require('ws');

// 连接到 WebSocket 服务器
const ws = new WebSocket('ws://localhost:8080');

ws.on('open', () => {
    console.log('连接已建立');
    
    // 发送聊天消息
    ws.send(JSON.stringify({
        type: 'chat_message',
        user: 'Alice',
        message: 'Hello everyone!'
    }));
    
    // 发送打字状态
    ws.send(JSON.stringify({
        type: 'typing',
        user: 'Alice',
        typing: true
    }));
});

ws.on('message', (data) => {
    try {
        const message = JSON.parse(data);
        console.log('收到消息:', message);
        
        switch (message.type) {
            case 'chat_message':
                console.log(`${message.user}: ${message.message}`);
                break;
            case 'user_joined':
                console.log('有用户加入聊天室');
                break;
            case 'user_left':
                console.log('有用户离开聊天室');
                break;
            case 'typing':
                console.log(`${message.user} 正在输入...`);
                break;
        }
    } catch (error) {
        console.error('消息解析错误:', error);
    }
});

ws.on('close', () => {
    console.log('连接已关闭');
});

ws.on('error', (error) => {
    console.error('连接错误:', error);
});
```

### TCP/UDP 网络编程

**TCP 服务器：**
```javascript
const net = require('net');

// 创建 TCP 服务器
const tcpServer = net.createServer((socket) => {
    console.log(`客户端连接: ${socket.remoteAddress}:${socket.remotePort}`);
    
    // 发送欢迎消息
    socket.write('欢迎连接到 TCP 服务器!\n');
    
    // 处理数据接收
    socket.on('data', (data) => {
        const message = data.toString().trim();
        console.log(`收到消息: ${message}`);
        
        // 回显消息
        socket.write(`服务器回复: ${message}\n`);
        
        // 特殊命令处理
        if (message.toLowerCase() === 'quit') {
            socket.write('再见!\n');
            socket.end();
        } else if (message.toLowerCase() === 'time') {
            socket.write(`当前时间: ${new Date().toISOString()}\n`);
        }
    });
    
    // 处理连接关闭
    socket.on('end', () => {
        console.log('客户端断开连接');
    });
    
    // 处理错误
    socket.on('error', (err) => {
        console.error('Socket 错误:', err);
    });
});

// 服务器错误处理
tcpServer.on('error', (err) => {
    console.error('服务器错误:', err);
});

// 启动服务器
tcpServer.listen(9000, () => {
    console.log('TCP 服务器监听端口 9000');
});
```

**TCP 客户端：**
```javascript
const net = require('net');

// 创建 TCP 客户端
const client = new net.Socket();

client.connect(9000, 'localhost', () => {
    console.log('连接到服务器');
    client.write('Hello Server!\n');
});

client.on('data', (data) => {
    console.log('服务器回复:', data.toString());
    
    // 模拟用户输入
    setTimeout(() => {
        client.write('time\n');
    }, 1000);
    
    setTimeout(() => {
        client.write('quit\n');
    }, 2000);
});

client.on('close', () => {
    console.log('连接关闭');
});

client.on('error', (err) => {
    console.error('客户端错误:', err);
});
```

**UDP 服务器：**
```javascript
const dgram = require('dgram');

// 创建 UDP 服务器
const udpServer = dgram.createSocket('udp4');

udpServer.on('message', (msg, rinfo) => {
    console.log(`收到消息: ${msg} from ${rinfo.address}:${rinfo.port}`);
    
    // 回复消息
    const reply = `服务器回复: ${msg}`;
    udpServer.send(reply, rinfo.port, rinfo.address, (err) => {
        if (err) {
            console.error('发送回复失败:', err);
        }
    });
});

udpServer.on('listening', () => {
    const address = udpServer.address();
    console.log(`UDP 服务器监听 ${address.address}:${address.port}`);
});

udpServer.on('error', (err) => {
    console.error('UDP 服务器错误:', err);
    udpServer.close();
});

// 启动服务器
udpServer.bind(9001);
```

**UDP 客户端：**
```javascript
const dgram = require('dgram');

// 创建 UDP 客户端
const client = dgram.createSocket('udp4');

const message = Buffer.from('Hello UDP Server!');
const port = 9001;
const host = 'localhost';

client.send(message, port, host, (err) => {
    if (err) {
        console.error('发送失败:', err);
    } else {
        console.log('消息已发送');
    }
});

client.on('message', (msg, rinfo) => {
    console.log(`收到回复: ${msg} from ${rinfo.address}:${rinfo.port}`);
    client.close();
});

client.on('error', (err) => {
    console.error('客户端错误:', err);
    client.close();
});
```

### 网络安全考虑

**HTTPS 服务器：**
```javascript
const https = require('https');
const fs = require('fs');

// HTTPS 配置
const options = {
    key: fs.readFileSync('private-key.pem'),
    cert: fs.readFileSync('certificate.pem'),
    // 可选：CA 证书
    ca: fs.readFileSync('ca-certificate.pem')
};

// 创建 HTTPS 服务器
const httpsServer = https.createServer(options, (req, res) => {
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    res.end('Hello HTTPS World!\n');
});

httpsServer.listen(443, () => {
    console.log('HTTPS 服务器运行在 https://localhost');
});
```

**安全头设置：**
```javascript
const http = require('http');

const server = http.createServer((req, res) => {
    // 设置安全头
    res.setHeader('X-Content-Type-Options', 'nosniff');
    res.setHeader('X-Frame-Options', 'DENY');
    res.setHeader('X-XSS-Protection', '1; mode=block');
    res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
    res.setHeader('Content-Security-Policy', "default-src 'self'");
    
    res.writeHead(200, { 'Content-Type': 'text/html' });
    res.end(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>安全示例</title>
        </head>
        <body>
            <h1>Hello Secure World!</h1>
        </body>
        </html>
    `);
});

server.listen(3000);
```

**速率限制实现：**
```javascript
const http = require('http');

// 简单的速率限制
const rateLimiter = new Map();

function isRateLimited(ip, maxRequests = 10, windowMs = 60000) {
    const now = Date.now();
    const windowStart = now - windowMs;
    
    if (!rateLimiter.has(ip)) {
        rateLimiter.set(ip, []);
    }
    
    const requests = rateLimiter.get(ip);
    
    // 清除过期请求
    const validRequests = requests.filter(time => time > windowStart);
    validRequests.push(now);
    rateLimiter.set(ip, validRequests);
    
    return validRequests.length > maxRequests;
}

const server = http.createServer((req, res) => {
    const clientIP = req.connection.remoteAddress;
    
    if (isRateLimited(clientIP)) {
        res.writeHead(429, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: 'Too Many Requests' }));
        return;
    }
    
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ message: 'Hello World!' }));
});

server.listen(3000);
```