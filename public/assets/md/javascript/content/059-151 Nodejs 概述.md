## 15.1 Node.js 概述

### Node.js 架构和特点

**架构概述：**
Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境，采用单线程事件循环架构。

```javascript
// Node.js 架构层次
┌──────────────────────────────────┐
│           应用程序层              │
├──────────────────────────────────┤
│        Node.js 标准库            │
├──────────────────────────────────┤
│        V8 引擎 + libuv           │
├──────────────────────────────────┤
│         操作系统 API             │
└──────────────────────────────────┘
```

**主要特点：**
- **单线程**：避免多线程的复杂性
- **非阻塞 I/O**：提高并发处理能力
- **事件驱动**：基于事件循环机制
- **跨平台**：支持 Windows、Linux、macOS

### V8 引擎工作机制

**V8 引擎组成：**
```javascript
// V8 引擎内部结构
┌─────────────┐    ┌─────────────┐
│   Parser    │    │  Ignition   │
│  (解析器)    │───▶│ (解释器)     │
└─────────────┘    └─────────────┘
                          │
                   ┌─────────────┐
                   │   TurboFan  │
                   │  (编译器)    │
                   └─────────────┘
```

**性能优化机制：**
```javascript
// 1. JIT 编译
function add(a, b) {
    return a + b; // 首次解释执行，后续优化编译
}

// 2. 内联缓存
const obj = { name: 'Node.js' };
console.log(obj.name); // 快速属性访问

// 3. 垃圾回收
// 新生代和老生代分代回收
```

### 事件驱动和非阻塞 I/O

**事件循环机制：**
```javascript
// 事件循环阶段
┌─────────────────────────────────────┐
│               timers                │
│    ┌─────────────────────────────┐  │
│    │ setTimeout(), setInterval() │  │
│    └─────────────────────────────┘  │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│         pending callbacks           │
│    ┌─────────────────────────────┐  │
│    │  TCP errors, etc.          │  │
│    └─────────────────────────────┘  │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│        idle, prepare                │
│    ┌─────────────────────────────┐  │
│    │   only used internally      │  │
│    └─────────────────────────────┘  │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│              poll                   │
│    ┌─────────────────────────────┐  │
│    │ I/O callbacks, incoming     │  │
│    │ connections, data, etc.     │  │
│    └─────────────────────────────┘  │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│              check                  │
│    ┌─────────────────────────────┐  │
│    │      setImmediate()         │  │
│    └─────────────────────────────┘  │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│         close callbacks             │
│    ┌─────────────────────────────┐  │
│    │   socket.on('close', ...)   │  │
│    └─────────────────────────────┘  │
└─────────────────────────────────────┘
```

**非阻塞 I/O 示例：**
```javascript
const fs = require('fs');

// 阻塞方式（不推荐）
// const data = fs.readFileSync('file.txt');
// console.log(data.toString());

// 非阻塞方式（推荐）
fs.readFile('file.txt', (err, data) => {
    if (err) throw err;
    console.log(data.toString());
});

console.log('读取文件中...'); // 先执行
```

### Node.js 应用场景

**适用场景：**
```javascript
// 1. Web 服务器
const http = require('http');

const server = http.createServer((req, res) => {
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    res.end('Hello Node.js!');
});

server.listen(3000);

// 2. API 服务
const express = require('express');
const app = express();

app.get('/api/users', (req, res) => {
    res.json({ users: [] });
});

// 3. 实时应用
const WebSocket = require('ws');
const wss = new WebSocket.Server({ port: 8080 });

wss.on('connection', (ws) => {
    ws.on('message', (message) => {
        console.log('received:', message);
    });
});

// 4. 命令行工具
#!/usr/bin/env node
const program = require('commander');

program
    .version('1.0.0')
    .command('init')
    .action(() => {
        console.log('初始化项目');
    });
```