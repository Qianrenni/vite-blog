## 15.3 模块系统

### CommonJS 规范

**模块定义和导出：**
```javascript
// math.js - 模块定义
function add(a, b) {
    return a + b;
}

function subtract(a, b) {
    return a - b;
}

// 方式1: 对象导出
module.exports = {
    add,
    subtract
};

// 方式2: 单个导出
module.exports.add = add;
module.exports.subtract = subtract;

// 方式3: exports 简写
exports.add = add;
exports.subtract = subtract;

// 方式4: 默认导出
module.exports = add; // 默认导出 add 函数
```

**模块导入：**
```javascript
// app.js - 模块使用
const math = require('./math'); // 导入整个模块
const { add, subtract } = require('./math'); // 解构导入
const addFunction = require('./math'); // 导入默认导出

console.log(math.add(1, 2)); // 3
console.log(add(1, 2)); // 3
console.log(addFunction(1, 2)); // 3
```

### 模块加载机制

**模块解析过程：**
```javascript
// 模块加载顺序
// 1. 核心模块
const fs = require('fs');

// 2. 相对路径文件模块
const myModule = require('./myModule');

// 3. 绝对路径文件模块
const absoluteModule = require('/absolute/path/to/module');

// 4. node_modules 中的模块
const express = require('express');

// 模块缓存机制
console.log(require.cache); // 查看模块缓存

// 清除模块缓存
delete require.cache[require.resolve('./myModule')];
```

**模块包装：**
```javascript
// Node.js 实际上将模块包装成函数
(function(exports, require, module, __filename, __dirname) {
    // 模块代码在这里执行
    const fs = require('fs');
    
    function myFunction() {
        console.log(__filename); // 当前文件路径
        console.log(__dirname);  // 当前目录路径
    }
    
    module.exports = myFunction;
});
```

### 内置模块和第三方模块

**内置模块使用：**
```javascript
// 常用内置模块
const os = require('os');
const path = require('path');
const fs = require('fs');
const http = require('http');
const crypto = require('crypto');

// 系统信息
console.log(os.platform()); // 操作系统平台
console.log(os.cpus()); // CPU 信息
console.log(os.totalmem()); // 总内存

// 加密
const hash = crypto.createHash('sha256');
hash.update('password');
console.log(hash.digest('hex'));
```

**第三方模块管理：**
```json
// package.json
{
  "name": "my-app",
  "version": "1.0.0",
  "dependencies": {
    "express": "^4.18.0",
    "lodash": "^4.17.21"
  },
  "devDependencies": {
    "nodemon": "^2.0.20"
  },
  "scripts": {
    "start": "node app.js",
    "dev": "nodemon app.js"
  }
}
```

```javascript
// 使用第三方模块
const express = require('express');
const _ = require('lodash');

const app = express();

// lodash 使用示例
const users = [
    { name: 'Alice', age: 25 },
    { name: 'Bob', age: 30 }
];

const youngUsers = _.filter(users, user => user.age < 30);
console.log(youngUsers);
```

### 模块缓存机制

**缓存演示：**
```javascript
// counter.js
let count = 0;

function increment() {
    return ++count;
}

module.exports = {
    increment,
    getCount: () => count
};

// app.js
const counter1 = require('./counter');
const counter2 = require('./counter'); // 同一个模块

console.log(counter1.increment()); // 1
console.log(counter2.increment()); // 2
console.log(counter1 === counter2); // true - 同一个实例

// 查看缓存
console.log(Object.keys(require.cache));

// 清除缓存（开发环境调试用）
delete require.cache[require.resolve('./counter')];
```

**循环依赖处理：**
```javascript
// a.js
console.log('a 开始');
exports.done = false;
const b = require('./b.js');
console.log('在 a 中, b.done = %j', b.done);
exports.done = true;
console.log('a 结束');

// b.js
console.log('b 开始');
exports.done = false;
const a = require('./a.js'); // 循环依赖
console.log('在 b 中, a.done = %j', a.done);
exports.done = true;
console.log('b 结束');

// main.js
console.log('main 开始');
const a = require('./a.js');
const b = require('./b.js');
console.log('在 main 中, a.done=%j, b.done=%j', a.done, b.done);
```