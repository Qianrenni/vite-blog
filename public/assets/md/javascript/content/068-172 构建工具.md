## 17.2 构建工具

### Webpack 模块打包

**webpack.config.js 基础配置：**
```javascript
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');
const { CleanWebpackPlugin } = require('clean-webpack-plugin');

module.exports = (env, argv) => {
    const isProduction = argv.mode === 'production';
    
    return {
        entry: {
            main: './src/index.js',
            vendor: './src/vendor.js'
        },
        output: {
            path: path.resolve(__dirname, 'dist'),
            filename: isProduction ? '[name].[contenthash].js' : '[name].js',
            chunkFilename: isProduction ? '[name].[contenthash].chunk.js' : '[name].chunk.js',
            publicPath: '/'
        },
        module: {
            rules: [
                {
                    test: /\.js$/,
                    exclude: /node_modules/,
                    use: {
                        loader: 'babel-loader',
                        options: {
                            presets: ['@babel/preset-env']
                        }
                    }
                },
                {
                    test: /\.css$/,
                    use: [
                        isProduction ? MiniCssExtractPlugin.loader : 'style-loader',
                        'css-loader',
                        'postcss-loader'
                    ]
                },
                {
                    test: /\.scss$/,
                    use: [
                        isProduction ? MiniCssExtractPlugin.loader : 'style-loader',
                        'css-loader',
                        'sass-loader'
                    ]
                },
                {
                    test: /\.(png|jpe?g|gif|svg)$/i,
                    type: 'asset/resource',
                    generator: {
                        filename: 'images/[name].[hash][ext]'
                    }
                },
                {
                    test: /\.(woff|woff2|eot|ttf|otf)$/i,
                    type: 'asset/resource',
                    generator: {
                        filename: 'fonts/[name].[hash][ext]'
                    }
                }
            ]
        },
        plugins: [
            new CleanWebpackPlugin(),
            new HtmlWebpackPlugin({
                template: './src/index.html',
                minify: isProduction ? {
                    removeComments: true,
                    collapseWhitespace: true,
                    removeRedundantAttributes: true
                } : false
            }),
            ...(isProduction ? [
                new MiniCssExtractPlugin({
                    filename: '[name].[contenthash].css'
                })
            ] : [])
        ],
        optimization: {
            splitChunks: {
                chunks: 'all',
                cacheGroups: {
                    vendor: {
                        test: /[\\/]node_modules[\\/]/,
                        name: 'vendors',
                        chunks: 'all'
                    }
                }
            }
        },
        devServer: {
            contentBase: path.join(__dirname, 'dist'),
            compress: true,
            port: 3000,
            hot: true,
            open: true,
            historyApiFallback: true
        },
        devtool: isProduction ? 'source-map' : 'eval-source-map'
    };
};
```

**高级 Webpack 配置：**
```javascript
const webpack = require('webpack');
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin;

module.exports = {
    // ... 基础配置
    
    resolve: {
        extensions: ['.js', '.jsx', '.json'],
        alias: {
            '@': path.resolve(__dirname, 'src'),
            '@components': path.resolve(__dirname, 'src/components'),
            '@utils': path.resolve(__dirname, 'src/utils')
        },
        modules: [
            'node_modules',
            path.resolve(__dirname, 'src')
        ]
    },
    
    externals: {
        'lodash': '_',
        'jquery': 'jQuery'
    },
    
    performance: {
        maxAssetSize: 250000,
        maxEntrypointSize: 250000,
        hints: 'warning'
    },
    
    plugins: [
        // ... 其他插件
        
        new webpack.DefinePlugin({
            'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV),
            'API_URL': JSON.stringify('https://api.example.com')
        }),
        
        new BundleAnalyzerPlugin({
            analyzerMode: 'static',
            openAnalyzer: false
        })
    ]
};
```

### Gulp 任务自动化

**gulpfile.js 基础配置：**
```javascript
const gulp = require('gulp');
const sass = require('gulp-sass')(require('sass'));
const uglify = require('gulp-uglify');
const concat = require('gulp-concat');
const sourcemaps = require('gulp-sourcemaps');
const rename = require('gulp-rename');
const cleanCSS = require('gulp-clean-css');
const imagemin = require('gulp-imagemin');
const del = require('del');
const browserSync = require('browser-sync').create();

// 清理任务
gulp.task('clean', () => {
    return del(['dist/**/*']);
});

// CSS 处理任务
gulp.task('styles', () => {
    return gulp.src('src/scss/**/*.scss')
        .pipe(sourcemaps.init())
        .pipe(sass().on('error', sass.logError))
        .pipe(cleanCSS())
        .pipe(rename({ suffix: '.min' }))
        .pipe(sourcemaps.write('.'))
        .pipe(gulp.dest('dist/css'))
        .pipe(browserSync.stream());
});

// JavaScript 处理任务
gulp.task('scripts', () => {
    return gulp.src('src/js/**/*.js')
        .pipe(sourcemaps.init())
        .pipe(concat('main.js'))
        .pipe(uglify())
        .pipe(rename({ suffix: '.min' }))
        .pipe(sourcemaps.write('.'))
        .pipe(gulp.dest('dist/js'))
        .pipe(browserSync.stream());
});

// 图片优化任务
gulp.task('images', () => {
    return gulp.src('src/images/**/*')
        .pipe(imagemin([
            imagemin.gifsicle({ interlaced: true }),
            imagemin.mozjpeg({ quality: 75, progressive: true }),
            imagemin.optipng({ optimizationLevel: 5 }),
            imagemin.svgo({
                plugins: [
                    { removeViewBox: true },
                    { cleanupIDs: false }
                ]
            })
        ]))
        .pipe(gulp.dest('dist/images'));
});

// HTML 复制任务
gulp.task('html', () => {
    return gulp.src('src/**/*.html')
        .pipe(gulp.dest('dist'))
        .pipe(browserSync.stream());
});

// 文件监听任务
gulp.task('watch', () => {
    gulp.watch('src/scss/**/*.scss', gulp.series('styles'));
    gulp.watch('src/js/**/*.js', gulp.series('scripts'));
    gulp.watch('src/**/*.html', gulp.series('html'));
    gulp.watch('src/images/**/*', gulp.series('images'));
});

// 浏览器同步
gulp.task('serve', () => {
    browserSync.init({
        server: {
            baseDir: './dist'
        },
        port: 3000,
        open: true
    });
});

// 构建任务
gulp.task('build', gulp.series(
    'clean',
    gulp.parallel('styles', 'scripts', 'images', 'html')
));

// 开发任务
gulp.task('dev', gulp.series(
    'build',
    gulp.parallel('serve', 'watch')
));

// 默认任务
gulp.task('default', gulp.series('build'));
```

**高级 Gulp 任务：**
```javascript
const gulp = require('gulp');
const babel = require('gulp-babel');
const eslint = require('gulp-eslint');
const jest = require('gulp-jest').default;
const zip = require('gulp-zip');
const ftp = require('vinyl-ftp');

// 代码检查任务
gulp.task('lint', () => {
    return gulp.src(['src/js/**/*.js'])
        .pipe(eslint())
        .pipe(eslint.format())
        .pipe(eslint.failAfterError());
});

// 测试任务
gulp.task('test', () => {
    return gulp.src('test/').pipe(jest({
        "preprocessorIgnorePatterns": [
            "<rootDir>/dist/", "<rootDir>/node_modules/"
        ],
        "automock": false
    }));
});

// Babel 转换任务
gulp.task('babel', () => {
    return gulp.src('src/js/**/*.js')
        .pipe(babel({
            presets: ['@babel/env']
        }))
        .pipe(gulp.dest('dist/js'));
});

// 打包任务
gulp.task('package', () => {
    return gulp.src('dist/**/*')
        .pipe(zip('project.zip'))
        .pipe(gulp.dest('packages'));
});

// 部署任务
gulp.task('deploy', () => {
    const conn = ftp.create({
        host: 'mywebsite.com',
        user: process.env.FTP_USER,
        password: process.env.FTP_PASSWORD,
        parallel: 10
    });
    
    return gulp.src('dist/**/*', { base: 'dist', buffer: false })
        .pipe(conn.dest('/public_html'));
});

// 复合任务
gulp.task('ci', gulp.series(
    'lint',
    'test',
    'build',
    'package'
));
```

### Babel 代码转换

**babel.config.js 配置：**
```javascript
module.exports = {
    presets: [
        [
            '@babel/preset-env',
            {
                targets: {
                    browsers: ['> 1%', 'last 2 versions', 'not ie <= 8']
                },
                useBuiltIns: 'usage',
                corejs: 3
            }
        ],
        '@babel/preset-react'
    ],
    plugins: [
        '@babel/plugin-proposal-class-properties',
        '@babel/plugin-proposal-object-rest-spread',
        [
            '@babel/plugin-transform-runtime',
            {
                corejs: 3,
                helpers: true,
                regenerator: true
            }
        ]
    ],
    env: {
        development: {
            plugins: ['@babel/plugin-transform-runtime']
        },
        production: {
            plugins: [
                '@babel/plugin-transform-runtime',
                'babel-plugin-transform-remove-console'
            ]
        }
    }
};
```

**按需加载配置：**
```javascript
// babel.config.js
module.exports = {
    presets: [
        [
            '@babel/preset-env',
            {
                modules: false, // 保持 ES6 模块语法
                useBuiltIns: 'usage',
                corejs: 3,
                targets: {
                    browsers: ['> 1%', 'last 2 versions']
                }
            }
        ]
    ],
    plugins: [
        [
            '@babel/plugin-transform-runtime',
            {
                corejs: 3,
                helpers: true,
                regenerator: true,
                useESModules: true
            }
        ],
        // 装饰器支持
        ['@babel/plugin-proposal-decorators', { legacy: true }],
        ['@babel/plugin-proposal-class-properties', { loose: true }]
    ]
};
```

### ESLint 代码检查

**.eslintrc.js 配置：**
```javascript
module.exports = {
    env: {
        browser: true,
        es2021: true,
        node: true,
        jest: true
    },
    extends: [
        'eslint:recommended',
        '@typescript-eslint/recommended',
        'plugin:react/recommended',
        'plugin:import/errors',
        'plugin:import/warnings'
    ],
    parser: '@typescript-eslint/parser',
    parserOptions: {
        ecmaFeatures: {
            jsx: true
        },
        ecmaVersion: 12,
        sourceType: 'module'
    },
    plugins: [
        'react',
        '@typescript-eslint',
        'import'
    ],
    settings: {
        react: {
            version: 'detect'
        },
        'import/resolver': {
            node: {
                paths: ['src'],
                extensions: ['.js', '.jsx', '.ts', '.tsx']
            }
        }
    },
    rules: {
        'indent': ['error', 2],
        'linebreak-style': ['error', 'unix'],
        'quotes': ['error', 'single'],
        'semi': ['error', 'always'],
        'no-unused-vars': 'warn',
        'no-console': 'warn',
        'react/prop-types': 'off',
        'import/order': [
            'error',
            {
                'groups': ['builtin', 'external', 'internal'],
                'pathGroups': [
                    {
                        'pattern': 'react',
                        'group': 'external',
                        'position': 'before'
                    }
                ],
                'pathGroupsExcludedImportTypes': ['react'],
                'alphabetize': {
                    'order': 'asc',
                    'caseInsensitive': true
                }
            }
        ]
    },
    overrides: [
        {
            files: ['*.test.js', '*.spec.js'],
            env: {
                jest: true
            }
        }
    ]
};
```

**高级 ESLint 配置：**
```javascript
// .eslintrc.js
module.exports = {
    // ... 基础配置
    
    rules: {
        // 代码质量规则
        'no-console': ['warn', { allow: ['warn', 'error'] }],
        'no-debugger': 'error',
        'no-alert': 'warn',
        'no-var': 'error',
        'prefer-const': 'error',
        'no-duplicate-imports': 'error',
        
        // 风格规则
        'comma-dangle': ['error', 'always-multiline'],
        'object-curly-spacing': ['error', 'always'],
        'array-bracket-spacing': ['error', 'never'],
        'space-before-function-paren': ['error', {
            'asyncArrow': 'always',
            'anonymous': 'never',
            'named': 'never'
        }],
        
        // 复杂度控制
        'complexity': ['warn', 10],
        'max-depth': ['warn', 4],
        'max-lines': ['warn', 300],
        'max-params': ['warn', 3],
        
        // 导入规则
        'import/no-unresolved': 'error',
        'import/named': 'error',
        'import/default': 'error',
        'import/no-self-import': 'error',
        'import/no-cycle': 'error'
    },
    
    // 自定义规则
    plugins: [
        // ... 其他插件
        'sonarjs'  // 代码质量分析
    ],
    
    extends: [
        // ... 其他扩展
        'plugin:sonarjs/recommended'
    ]
};
```