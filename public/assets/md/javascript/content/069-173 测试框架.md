## 17.3 测试框架

### Jest 测试框架

**Jest 基础配置：**
```javascript
// jest.config.js
module.exports = {
    testEnvironment: 'node',
    testMatch: [
        '**/__tests__/**/*.{js,jsx,ts,tsx}',
        '**/?(*.)+(spec|test).{js,jsx,ts,tsx}'
    ],
    testPathIgnorePatterns: [
        '/node_modules/',
        '/dist/'
    ],
    collectCoverageFrom: [
        'src/**/*.{js,jsx,ts,tsx}',
        '!src/**/*.d.ts'
    ],
    coverageDirectory: 'coverage',
    coverageReporters: ['text', 'lcov', 'html'],
    setupFilesAfterEnv: ['<rootDir>/test/setup.js'],
    moduleNameMapper: {
        '^@/(.*)$': '<rootDir>/src/$1',
        '\\.(css|less|scss|sass)$': 'identity-obj-proxy'
    },
    transform: {
        '^.+\\.(js|jsx|ts|tsx)$': 'babel-jest'
    },
    watchPlugins: [
        'jest-watch-typeahead/filename',
        'jest-watch-typeahead/testname'
    ]
};
```

**基础测试示例：**
```javascript
// math.js
function add(a, b) {
    return a + b;
}

function subtract(a, b) {
    return a - b;
}

function divide(a, b) {
    if (b === 0) {
        throw new Error('Division by zero');
    }
    return a / b;
}

module.exports = { add, subtract, divide };

// math.test.js
const { add, subtract, divide } = require('./math');

describe('数学运算测试', () => {
    describe('加法运算', () => {
        test('应该正确计算两个正数的和', () => {
            expect(add(2, 3)).toBe(5);
        });

        test('应该正确计算负数和正数的和', () => {
            expect(add(-1, 1)).toBe(0);
        });

        test('应该正确计算小数的和', () => {
            expect(add(0.1, 0.2)).toBeCloseTo(0.3);
        });
    });

    describe('减法运算', () => {
        test('应该正确计算两个数的差', () => {
            expect(subtract(5, 3)).toBe(2);
        });

        test('应该正确处理负数', () => {
            expect(subtract(-1, -2)).toBe(1);
        });
    });

    describe('除法运算', () => {
        test('应该正确计算两个数的商', () => {
            expect(divide(10, 2)).toBe(5);
        });

        test('应该在除零时抛出错误', () => {
            expect(() => divide(10, 0)).toThrow('Division by zero');
        });

        test('应该正确处理小数除法', () => {
            expect(divide(1, 3)).toBeCloseTo(0.333333, 5);
        });
    });
});
```

**异步测试：**
```javascript
// api.js
const fetch = require('node-fetch');

async function fetchUser(id) {
    const response = await fetch(`https://jsonplaceholder.typicode.com/users/${id}`);
    if (!response.ok) {
        throw new Error('User not found');
    }
    return response.json();
}

function fetchUserWithCallback(id, callback) {
    fetch(`https://jsonplaceholder.typicode.com/users/${id}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('User not found');
            }
            return response.json();
        })
        .then(data => callback(null, data))
        .catch(error => callback(error));
}

module.exports = { fetchUser, fetchUserWithCallback };

// api.test.js
const { fetchUser, fetchUserWithCallback } = require('./api');

// Mock fetch
global.fetch = jest.fn();

describe('API 测试', () => {
    beforeEach(() => {
        fetch.mockClear();
    });

    test('应该成功获取用户数据', async () => {
        const mockUser = { id: 1, name: 'John Doe' };
        
        fetch.mockResolvedValue({
            ok: true,
            json: () => Promise.resolve(mockUser)
        });

        const user = await fetchUser(1);
        expect(user).toEqual(mockUser);
        expect(fetch).toHaveBeenCalledWith('https://jsonplaceholder.typicode.com/users/1');
    });

    test('应该在用户不存在时抛出错误', async () => {
        fetch.mockResolvedValue({
            ok: false
        });

        await expect(fetchUser(999)).rejects.toThrow('User not found');
    });

    test('应该支持回调函数方式', (done) => {
        const mockUser = { id: 1, name: 'John Doe' };
        
        fetch.mockResolvedValue({
            ok: true,
            json: () => Promise.resolve(mockUser)
        });

        fetchUserWithCallback(1, (error, user) => {
            expect(error).toBeNull();
            expect(user).toEqual(mockUser);
            done();
        });
    });
});
```

### Mocha 测试运行器

**Mocha 基础配置：**
```javascript
// .mocharc.js
module.exports = {
    require: [
        '@babel/register',
        'chai/register-expect'
    ],
    reporter: 'spec',
    timeout: 5000,
    recursive: true,
    extension: ['js'],
    file: ['./test/setup.js'],
    watchFiles: ['src/**/*.js', 'test/**/*.js']
};
```

**Mocha 测试示例：**
```javascript
// 使用 Chai 断言库
const { expect } = require('chai');
const sinon = require('sinon');
const { add, subtract } = require('../src/math');

describe('数学运算测试', function() {
    describe('加法运算', function() {
        it('应该正确计算两个正数的和', function() {
            const result = add(2, 3);
            expect(result).to.equal(5);
        });

        it('应该正确计算负数和正数的和', function() {
            const result = add(-1, 1);
            expect(result).to.equal(0);
        });

        it('应该正确计算小数的和', function() {
            const result = add(0.1, 0.2);
            expect(result).to.be.closeTo(0.3, 0.001);
        });
    });

    describe('减法运算', function() {
        it('应该正确计算两个数的差', function() {
            const result = subtract(5, 3);
            expect(result).to.equal(2);
        });
    });

    // 异步测试
    describe('异步操作', function() {
        it('应该处理 Promise', function() {
            return Promise.resolve(42)
                .then(value => {
                    expect(value).to.equal(42);
                });
        });

        it('应该处理 async/await', async function() {
            const result = await Promise.resolve('hello');
            expect(result).to.equal('hello');
        });

        it('应该处理回调函数', function(done) {
            setTimeout(() => {
                expect(true).to.be.true;
                done();
            }, 100);
        });
    });

    // 钩子函数
    before(function() {
        console.log('所有测试开始前执行');
    });

    after(function() {
        console.log('所有测试结束后执行');
    });

    beforeEach(function() {
        console.log('每个测试开始前执行');
    });

    afterEach(function() {
        console.log('每个测试结束后执行');
    });
});
```

### Chai 断言库

**Chai 断言风格：**
```javascript
const { expect, should, assert } = require('chai');

// Expect 风格 (推荐)
describe('Chai Expect 风格', function() {
    it('基本断言', function() {
        const value = 42;
        expect(value).to.equal(42);
        expect(value).to.be.a('number');
        expect(value).to.be.above(40);
        expect(value).to.be.below(50);
    });

    it('对象断言', function() {
        const obj = { name: 'John', age: 30 };
        expect(obj).to.have.property('name');
        expect(obj).to.have.property('name', 'John');
        expect(obj).to.include({ name: 'John' });
        expect(obj).to.deep.equal({ name: 'John', age: 30 });
    });

    it('数组断言', function() {
        const arr = [1, 2, 3];
        expect(arr).to.be.an('array');
        expect(arr).to.include(2);
        expect(arr).to.have.lengthOf(3);
        expect(arr).to.deep.equal([1, 2, 3]);
    });

    it('字符串断言', function() {
        const str = 'Hello World';
        expect(str).to.be.a('string');
        expect(str).to.contain('World');
        expect(str).to.match(/Hello/);
        expect(str).to.have.lengthOf(11);
    });

    it('函数断言', function() {
        const fn = () => { throw new Error('Oops!'); };
        expect(fn).to.throw();
        expect(fn).to.throw(Error);
        expect(fn).to.throw('Oops!');
    });
});

// Should 风格
describe('Chai Should 风格', function() {
    it('基本断言', function() {
        should();
        const value = 42;
        value.should.equal(42);
        value.should.be.a('number');
        value.should.be.above(40);
    });
});

// Assert 风格
describe('Chai Assert 风格', function() {
    it('基本断言', function() {
        const value = 42;
        assert.equal(value, 42);
        assert.typeOf(value, 'number');
        assert.isAbove(value, 40);
        assert.isBelow(value, 50);
    });
});
```

**Chai 插件使用：**
```javascript
const chai = require('chai');
const chaiAsPromised = require('chai-as-promised');
const chaiHttp = require('chai-http');
const sinonChai = require('sinon-chai');

// 注册插件
chai.use(chaiAsPromised);
chai.use(chaiHttp);
chai.use(sinonChai);

const { expect } = chai;

describe('Chai 插件测试', function() {
    // Promise 断言
    it('应该处理 Promise 断言', async function() {
        const promise = Promise.resolve('success');
        await expect(promise).to.eventually.equal('success');
        
        const rejectedPromise = Promise.reject(new Error('failure'));
        await expect(rejectedPromise).to.be.rejectedWith('failure');
    });

    // HTTP 断言
    it('应该处理 HTTP 请求', function() {
        // 注意：这需要真实的服务器
        // return chai.request(app)
        //     .get('/api/users')
        //     .then(res => {
        //         expect(res).to.have.status(200);
        //         expect(res).to.be.json;
        //     });
    });
});
```

### 测试覆盖率工具

**Istanbul/nyc 配置：**
```json
// package.json
{
  "scripts": {
    "test": "jest",
    "test:coverage": "jest --coverage",
    "test:coverage:html": "jest --coverage --coverageReporters=html",
    "test:watch": "jest --watch"
  },
  "nyc": {
    "extends": "@istanbuljs/nyc-config-babel",
    "all": true,
    "include": [
      "src/**/*.js"
    ],
    "exclude": [
      "src/**/*.test.js",
      "src/**/index.js"
    ],
    "reporter": [
      "text",
      "html",
      "lcov"
    ],
    "report-dir": "./coverage"
  }
}
```

**覆盖率报告分析：**
```javascript
// calculator.js
class Calculator {
    add(a, b) {
        if (typeof a !== 'number' || typeof b !== 'number') {
            throw new Error('参数必须是数字');
        }
        return a + b;
    }

    subtract(a, b) {
        return a - b;
    }

    multiply(a, b) {
        return a * b;
    }

    divide(a, b) {
        if (b === 0) {
            throw new Error('除数不能为零');
        }
        return a / b;
    }

    // 这个方法没有被测试覆盖
    power(base, exponent) {
        return Math.pow(base, exponent);
    }
}

module.exports = Calculator;

// calculator.test.js
const { expect } = require('chai');
const Calculator = require('./calculator');

describe('Calculator', function() {
    let calculator;

    beforeEach(function() {
        calculator = new Calculator();
    });

    describe('add', function() {
        it('应该正确计算两个数字的和', function() {
            expect(calculator.add(2, 3)).to.equal(5);
        });

        it('应该在参数不是数字时抛出错误', function() {
            expect(() => calculator.add('2', 3)).to.throw('参数必须是数字');
            expect(() => calculator.add(2, '3')).to.throw('参数必须是数字');
        });
    });

    describe('subtract', function() {
        it('应该正确计算两个数字的差', function() {
            expect(calculator.subtract(5, 3)).to.equal(2);
        });
    });

    describe('multiply', function() {
        it('应该正确计算两个数字的积', function() {
            expect(calculator.multiply(3, 4)).to.equal(12);
        });
    });

    describe('divide', function() {
        it('应该正确计算两个数字的商', function() {
            expect(calculator.divide(10, 2)).to.equal(5);
        });

        it('应该在除数为零时抛出错误', function() {
            expect(() => calculator.divide(10, 0)).to.throw('除数不能为零');
        });
    });

    // 注意：power 方法没有被测试，这会在覆盖率报告中显示
});
```

**CI/CD 集成：**
```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [14.x, 16.x, 18.x]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run lint
      run: npm run lint
    
    - name: Run tests
      run: npm run test:coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
```