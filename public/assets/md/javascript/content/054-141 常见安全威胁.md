## 14.1 常见安全威胁

### 1. XSS 攻击防护（跨站脚本攻击，Cross-Site Scripting）

#### 什么是 XSS？

XSS 是指攻击者将恶意脚本注入网页，当其他用户浏览时，脚本在他们的浏览器中执行，从而窃取 Cookie、会话令牌、篡改页面内容等。

#### XSS 类型：

| 类型 | 描述 | 示例 |
|------|------|------|
| **存储型 XSS** | 恶意脚本被永久存储在服务器（如评论、用户资料） | `<script>stealCookies()</script>` 存入数据库 |
| **反射型 XSS** | 恶意脚本通过 URL 参数反射回页面 | `https://example.com?search=<script>...</script>` |
| **DOM 型 XSS** | 通过 JavaScript 操作 DOM 注入脚本（纯前端） | `el.innerHTML = location.hash.slice(1)` |

#### 防护措施：

##### （1）输出编码（Output Encoding）

在将用户输入插入 HTML 前，进行 HTML 实体编码：

```js
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 使用
const userInput = '<script>alert("xss")</script>';
el.innerHTML = escapeHtml(userInput); // 显示为纯文本
```

##### （2）避免使用危险的 API

| 危险 API | 安全替代 |
|---------|----------|
| `innerHTML` | `textContent` |
| `document.write()` | `appendChild()` / `insertAdjacentHTML()` |
| `eval()` | 避免使用，改用 JSON.parse 等 |
| `setTimeout(string)` | 传函数而非字符串 |

✅ 推荐使用现代框架（React、Vue）的默认防护：
- React 使用 `{}` 插值自动转义
- Vue 使用 `{{ }}` 插值自动转义

##### （3）使用 CSP（内容安全策略）

通过 HTTP 头限制可执行的脚本来源：

```http
Content-Security-Policy: default-src 'self'; script-src 'self' https://trusted.cdn.com; object-src 'none';
```

- `'self'`：只允许同源脚本
- 禁止内联脚本（如 `<script>...</script>`）
- 禁止 `eval()`

> ✅ 强烈建议在生产环境中启用 CSP。

##### （4）使用 sanitizer 库

```js
import { sanitize } from 'dompurify';

const clean = sanitize(dirtyHTML); // 清理恶意标签
el.innerHTML = clean;
```

---

### 2. CSRF 攻击防范（跨站请求伪造，Cross-Site Request Forgery）

#### 什么是 CSRF？

攻击者诱导用户在已登录的状态下，向目标网站发送非预期的请求（如转账、修改密码），利用用户的认证状态执行操作。

#### 示例：

用户登录 `bank.com`，Cookie 被浏览器保存。  
攻击者诱导用户访问 `evil.com`，其中包含：

```html
<img src="https://bank.com/transfer?to=attacker&amount=1000" />
```

浏览器自动携带 `bank.com` 的 Cookie，完成转账。

#### 防护措施：

##### （1）使用 CSRF Token

- 服务器生成一次性 token，嵌入表单或响应头
- 前端在请求时携带 token（如 `X-CSRF-Token` 头）
- 服务器验证 token 有效性

```html
<!-- 表单中 -->
<input type="hidden" name="csrfToken" value="abc123" />
```

```js
// AJAX 请求
fetch('/api/action', {
    method: 'POST',
    headers: {
        'X-CSRF-Token': getToken(),
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
});
```

##### （2）SameSite Cookie 属性

设置 Cookie 的 `SameSite` 属性，防止跨站请求携带 Cookie：

```http
Set-Cookie: session=abc123; Path=/; Secure; HttpOnly; SameSite=Strict
```

- `Strict`：完全禁止跨站携带
- `Lax`：允许安全的跨站 GET 请求（推荐）
- `None`：允许跨站，但必须配合 `Secure`

✅ 建议设置为 `SameSite=Lax` 或 `Strict`。

##### （3）验证 `Origin` 或 `Referer` 头

服务器检查请求来源：

```js
// Node.js 示例
if (req.headers.origin !== 'https://yourdomain.com') {
    return res.status(403).send('Forbidden');
}
```

⚠️ 注意：`Referer` 可能被客户端屏蔽，不能作为唯一依据。

---

### 3. 数据注入攻击

#### （1）SQL 注入（Node.js 后端常见）

攻击者通过输入构造恶意 SQL 语句。

```js
// ❌ 危险：字符串拼接
const query = `SELECT * FROM users WHERE name = '${name}'`;

// ✅ 安全：使用参数化查询
db.query('SELECT * FROM users WHERE name = ?', [name]);
```

✅ 使用 ORM（如 Sequelize、TypeORM）或预处理语句。

#### （2）NoSQL 注入（MongoDB）

```js
// ❌ 危险
db.users.find({ username: req.body.username });

// 如果输入: { "$ne": "" } → 匹配所有用户

// ✅ 安全：验证和过滤输入
if (!/^[a-zA-Z0-9_]+$/.test(username)) {
    throw new Error('Invalid username');
}
```

#### （3）命令注入（Node.js）

```js
// ❌ 危险：执行系统命令
const { exec } = require('child_process');
exec(`ping ${ip}`, callback);

// 攻击输入: `127.0.0.1; rm -rf /`

// ✅ 安全：使用参数化或白名单
const ping = require('ping');
ping.promise.probe(ip);
```

---

### 4. 安全头设置（HTTP Security Headers）

通过 HTTP 响应头增强应用安全性。

#### 关键安全头：

| 头部 | 作用 | 示例 |
|------|------|------|
| `Content-Security-Policy` | 防止 XSS | `default-src 'self'; script-src 'self'` |
| `X-Content-Type-Options` | 禁止 MIME 类型嗅探 | `nosniff` |
| `X-Frame-Options` | 防止点击劫持 | `DENY` 或 `SAMEORIGIN` |
| `X-XSS-Protection` | 启用浏览器 XSS 过滤器（已过时） | `1; mode=block` |
| `Strict-Transport-Security` | 强制 HTTPS | `max-age=31536000; includeSubDomains` |
| `Referrer-Policy` | 控制 Referer 信息泄露 | `strict-origin-when-cross-origin` |

#### Node.js 中设置安全头（Express 示例）：

```js
const helmet = require('helmet');

app.use(helmet({
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            scriptSrc: ["'self'", "https://trusted.cdn.com"],
            objectSrc: ["'none'"],
        }
    },
    hsts: { maxAge: 31536000, includeSubDomains: true },
    frameguard: { action: 'deny' }
}));
```

✅ 推荐使用 `helmet` 库一键启用多种安全头。

---