## 17.1 包管理工具

### npm 包管理器使用

**npm 基本命令：**
```bash
# 初始化项目
npm init
npm init -y  # 快速初始化，使用默认配置

# 安装包
npm install express              # 安装最新版本
npm install express@4.18.0       # 安装指定版本
npm install express@^4.18.0      # 安装兼容版本
npm install express --save       # 安装并添加到 dependencies
npm install express --save-dev   # 安装并添加到 devDependencies
npm install -g nodemon           # 全局安装

# 卸载包
npm uninstall express
npm uninstall express --save

# 更新包
npm update express
npm update                       # 更新所有包

# 查看包信息
npm list                         # 查看已安装的包
npm list --depth=0              # 只显示顶层依赖
npm outdated                     # 查看过期的包
npm info express                 # 查看包详细信息

# 搜索包
npm search express

# 运行脚本
npm run start
npm run test
npm run build
```

**npm 高级用法：**
```bash
# 安装特定版本范围
npm install express@">=4.0.0 <5.0.0"
npm install express@"~4.18.0"  # 兼容补丁版本
npm install express@"^4.18.0"  # 兼容次要版本

# 安装 peer dependencies
npm install --save-peer react@18.0.0

# 安装可选依赖
npm install --save-optional fsevents

# 生产环境安装（不安装 devDependencies）
npm install --production

# 清理缓存
npm cache clean --force

# 查看 npm 配置
npm config list
npm config get registry
npm config set registry https://registry.npmjs.org/
```

### package.json 配置文件

**完整的 package.json 示例：**
```json
{
  "name": "my-awesome-project",
  "version": "1.0.0",
  "description": "一个很棒的 Node.js 项目",
  "keywords": ["node", "express", "api"],
  "homepage": "https://github.com/user/my-awesome-project#readme",
  "bugs": {
    "url": "https://github.com/user/my-awesome-project/issues",
    "email": "support@example.com"
  },
  "license": "MIT",
  "author": {
    "name": "张三",
    "email": "zhangsan@example.com",
    "url": "https://zhangsan.com"
  },
  "contributors": [
    {
      "name": "李四",
      "email": "lisi@example.com"
    }
  ],
  "files": [
    "dist/",
    "lib/",
    "README.md"
  ],
  "main": "lib/index.js",
  "module": "es/index.js",
  "browser": "dist/bundle.js",
  "bin": {
    "my-cli": "bin/cli.js"
  },
  "directories": {
    "lib": "lib",
    "test": "test"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/user/my-awesome-project.git"
  },
  "scripts": {
    "prestart": "npm run build",
    "start": "node dist/server.js",
    "dev": "nodemon src/server.js",
    "build": "webpack --mode=production",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "lint": "eslint src/**/*.js",
    "lint:fix": "eslint src/**/*.js --fix",
    "prepublishOnly": "npm run build",
    "postinstall": "node scripts/postinstall.js"
  },
  "dependencies": {
    "express": "^4.18.0",
    "mongoose": "^6.0.0",
    "cors": "^2.8.5"
  },
  "devDependencies": {
    "jest": "^28.0.0",
    "webpack": "^5.0.0",
    "babel-loader": "^8.0.0",
    "eslint": "^8.0.0",
    "nodemon": "^2.0.0"
  },
  "peerDependencies": {
    "react": "^18.0.0"
  },
  "optionalDependencies": {
    "fsevents": "^2.0.0"
  },
  "engines": {
    "node": ">=14.0.0",
    "npm": ">=6.0.0"
  },
  "os": ["darwin", "linux"],
  "cpu": ["x64"],
  "private": false,
  "publishConfig": {
    "access": "public"
  },
  "config": {
    "port": "3000"
  }
}
```

**脚本生命周期钩子：**
```json
{
  "scripts": {
    "preinstall": "echo '安装前'",
    "install": "echo '安装中'",
    "postinstall": "echo '安装后'",
    "prepublish": "echo '发布前'",
    "prepare": "echo '准备阶段'",
    "prepublishOnly": "echo '仅发布前'",
    "prepack": "echo '打包前'",
    "postpack": "echo '打包后'",
    "prestart": "npm run build",
    "start": "node server.js",
    "poststart": "echo '启动后'",
    "pretest": "npm run lint",
    "test": "jest",
    "posttest": "echo '测试后'"
  }
}
```

### 依赖版本管理

**语义化版本控制 (SemVer)：**
```json
{
  "dependencies": {
    "express": "4.18.0",        // 精确版本
    "lodash": "~4.17.20",       // 兼容补丁版本 (4.17.x)
    "moment": "^2.29.0",        // 兼容次要版本 (2.x.x)
    "axios": ">=0.21.0",        // 大于等于
    "react": "16.8.0 - 17.0.0", // 版本范围
    "vue": "latest",            // 最新版本
    "jquery": "*",              // 任意版本
    "bootstrap": "4.x || 5.x"   // 或关系
  }
}
```

**版本锁定和更新策略：**
```bash
# package-lock.json 的作用
# - 锁定依赖的确切版本
# - 确保团队间的一致性
# - 提高安装速度

# 生成 package-lock.json
npm install

# 忽略 package-lock.json
npm install --no-package-lock

# 更新 package-lock.json
npm install --package-lock-only

# 审计安全漏洞
npm audit
npm audit fix
npm audit fix --force
```

**依赖类型详解：**
```json
{
  "dependencies": {
    "express": "^4.18.0"        // 生产环境必需依赖
  },
  "devDependencies": {
    "jest": "^28.0.0",          // 开发环境依赖
    "eslint": "^8.0.0"          // 代码检查工具
  },
  "peerDependencies": {
    "react": "^18.0.0"          // 对等依赖（插件使用）
  },
  "optionalDependencies": {
    "fsevents": "^2.0.0"        // 可选依赖（可失败）
  },
  "bundledDependencies": [
    "lodash"                    // 捆绑依赖（打包发布）
  ]
}
```

### 脚本命令配置

**常用脚本配置：**
```json
{
  "scripts": {
    "dev": "nodemon src/index.js",
    "start": "node dist/index.js",
    "build": "webpack --mode=production",
    "build:dev": "webpack --mode=development",
    "test": "jest --passWithNoTests",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "lint": "eslint src/**/*.js",
    "lint:fix": "eslint src/**/*.js --fix",
    "format": "prettier --write src/**/*.js",
    "format:check": "prettier --check src/**/*.js",
    "type-check": "tsc --noEmit",
    "clean": "rimraf dist",
    "prebuild": "npm run clean",
    "postbuild": "echo '构建完成'",
    "deploy": "npm run build && gh-pages -d dist",
    "docker:build": "docker build -t myapp .",
    "docker:run": "docker run -p 3000:3000 myapp"
  }
}
```

**环境变量和配置：**
```json
{
  "scripts": {
    "start": "node index.js",
    "start:dev": "NODE_ENV=development node index.js",
    "start:prod": "NODE_ENV=production node index.js",
    "debug": "node --inspect index.js",
    "profile": "node --prof index.js",
    "analyze": "webpack-bundle-analyzer dist/stats.json"
  },
  "config": {
    "port": "3000",
    "host": "localhost"
  }
}
```