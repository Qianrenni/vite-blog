## 14.2 安全编码实践

### 1. 输入验证和过滤

所有用户输入都应视为**不可信**，必须验证和过滤。

#### 验证策略：

- **白名单验证**：只允许已知安全的字符或格式
- **类型检查**：确保输入是预期类型
- **长度限制**：防止超长输入导致缓冲区问题

```js
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function sanitizeInput(str) {
    return str.trim().slice(0, 100); // 去空格 + 截断
}
```

#### 使用验证库：

- `joi`（Node.js）
- `yup`（前端/后端）
- `validator.js`

```js
const schema = require('yup').object({
    email: yup.string().email().required(),
    age: yup.number().integer().min(18).max(120)
});

try {
    await schema.validate(userData);
} catch (err) {
    console.error(err.errors);
}
```

---

### 2. 输出编码处理

在将数据插入不同上下文时，必须进行相应编码。

#### 编码类型：

| 上下文 | 编码方式 |
|--------|----------|
| HTML 内容 | HTML 实体编码（`&`, `<`, `>`, `"`, `'`） |
| HTML 属性 | 同上，且属性值用引号包围 |
| JavaScript 字符串 | JavaScript 转义（`\n`, `\u2028` 等） |
| URL 参数 | `encodeURIComponent()` |
| CSS | CSS 转义 |

```js
// 安全插入 JavaScript 字符串
const userContent = 'Hello "world" <script>';
const safe = `<script>show("${userContent.replace(/"/g, '\\"')}")</script>`;
// ❌ 仍有风险，应避免内联脚本

// 安全 URL
const url = `https://api.com/search?q=${encodeURIComponent(query)}`;
```

✅ 最佳实践：尽量避免动态生成脚本或样式，使用数据驱动方式（如 React state）。

---

### 3. 权限控制机制

确保用户只能访问其被授权的资源。

#### 常见问题：

- **水平越权**：用户 A 访问用户 B 的数据（如 `/api/user/2`）
- **垂直越权**：普通用户访问管理员接口（如 `/admin/delete`）

#### 防护措施：

##### （1）服务端权限验证

```js
// Node.js 示例
app.get('/api/user/:id', auth, async (req, res) => {
    const userId = req.params.id;
    if (req.user.id !== userId && !req.user.isAdmin) {
        return res.status(403).send('Forbidden');
    }
    const user = await User.findById(userId);
    res.json(user);
});
```

##### （2）最小权限原则

- 用户只拥有完成任务所需的最小权限
- 管理员功能应二次验证（如输入密码）

##### （3）敏感操作日志

记录关键操作（如删除、修改密码），便于审计。

```js
logAction(req.user.id, 'DELETE_USER', targetUserId);
```

---

### 4. 安全审计流程

建立系统化的安全审查机制，持续发现和修复漏洞。

#### 审计内容：

| 项目 | 说明 |
|------|------|
| **代码审查** | 检查是否存在 XSS、SQL 注入、硬编码密钥等 |
| **依赖扫描** | 使用 `npm audit` 或 `snyk` 检查第三方库漏洞 |
| **渗透测试** | 模拟攻击，发现潜在漏洞 |
| **安全配置检查** | 验证 CSP、HTTPS、Cookie 属性等 |
| **日志监控** | 监控异常登录、频繁失败请求等 |

#### 自动化工具：

- `npm audit`：检查依赖漏洞
- `snyk`：持续监控依赖安全
- `Retire.js`：检测已知漏洞库
- `OWASP ZAP`：自动化渗透测试工具
- `SonarQube`：代码质量与安全分析

#### 安全发布流程（Security Release Process）：

1. 开发阶段：遵循安全编码规范
2. 代码审查：团队成员交叉审查
3. 自动化扫描：CI 中集成 `npm audit`、`snyk`
4. 安全测试：定期进行渗透测试
5. 上线前审计：检查生产配置
6. 监控响应：上线后监控异常行为

---