## 20.3 最佳实践

### 代码规范和风格

**ESLint 配置：**
```javascript
// .eslintrc.js
module.exports = {
    env: {
        browser: true,
        es2021: true,
        node: true,
        jest: true
    },
    extends: [
        'eslint:recommended',
        '@typescript-eslint/recommended',
        'plugin:import/errors',
        'plugin:import/warnings',
        'plugin:import/typescript',
        'plugin:jest/recommended',
        'plugin:jest/style',
        'plugin:sonarjs/recommended'
    ],
    parser: '@typescript-eslint/parser',
    parserOptions: {
        ecmaFeatures: {
            jsx: true
        },
        ecmaVersion: 12,
        sourceType: 'module'
    },
    plugins: [
        '@typescript-eslint',
        'import',
        'jest',
        'sonarjs',
        'unused-imports'
    ],
    settings: {
        'import/resolver': {
            node: {
                paths: ['src'],
                extensions: ['.js', '.jsx', '.ts', '.tsx']
            }
        }
    },
    rules: {
        // 基本规则
        'indent': ['error', 2],
        'linebreak-style': ['error', 'unix'],
        'quotes': ['error', 'single'],
        'semi': ['error', 'always'],
        
        // 导入规则
        'import/order': [
            'error',
            {
                'groups': ['builtin', 'external', 'internal'],
                'pathGroups': [
                    {
                        'pattern': 'react',
                        'group': 'external',
                        'position': 'before'
                    }
                ],
                'pathGroupsExcludedImportTypes': ['react'],
                'alphabetize': {
                    'order': 'asc',
                    'caseInsensitive': true
                }
            }
        ],
        'import/no-unresolved': 'error',
        'import/named': 'error',
        'import/default': 'error',
        'import/no-self-import': 'error',
        'import/no-cycle': 'error',
        
        // 未使用导入
        'unused-imports/no-unused-imports': 'error',
        'unused-imports/no-unused-vars': [
            'warn',
            {
                'vars': 'all',
                'varsIgnorePattern': '^_',
                'args': 'after-used',
                'argsIgnorePattern': '^_'
            }
        ],
        
        // 复杂度控制
        'complexity': ['warn', 10],
        'max-depth': ['warn', 4],
        'max-lines': ['warn', 300],
        'max-params': ['warn', 3],
        'max-statements': ['warn', 20],
        
        // 代码质量
        'no-console': ['warn', { allow: ['warn', 'error'] }],
        'no-debugger': 'error',
        'no-alert': 'warn',
        'no-var': 'error',
        'prefer-const': 'error',
        'no-duplicate-imports': 'error',
        
        // 风格规则
        'comma-dangle': ['error', 'always-multiline'],
        'object-curly-spacing': ['error', 'always'],
        'array-bracket-spacing': ['error', 'never'],
        'space-before-function-paren': ['error', {
            'asyncArrow': 'always',
            'anonymous': 'never',
            'named': 'never'
        }],
        
        // Jest 规则
        'jest/expect-expect': 'off',
        'jest/valid-title': 'error'
    },
    overrides: [
        {
            files: ['*.test.js', '*.spec.js'],
            env: {
                jest: true
            }
        }
    ]
};
```

**Prettier 配置：**
```javascript
// .prettierrc.js
module.exports = {
    semi: true,
    trailingComma: 'es5',
    singleQuote: true,
    printWidth: 80,
    tabWidth: 2,
    useTabs: false,
    bracketSpacing: true,
    arrowParens: 'avoid',
    endOfLine: 'lf',
    proseWrap: 'preserve'
};
```

**Git Hooks 配置：**
```json
// package.json
{
  "scripts": {
    "lint": "eslint src/**/*.js",
    "lint:fix": "eslint src/**/*.js --fix",
    "format": "prettier --write src/**/*.js",
    "format:check": "prettier --check src/**/*.js",
    "test": "jest",
    "test:watch": "jest --watch",
    "pre-commit": "lint-staged"
  },
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --fix",
      "prettier --write",
      "git add"
    ],
    "*.{json,md,yml,yaml}": [
      "prettier --write",
      "git add"
    ]
  },
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged",
      "pre-push": "npm run test"
    }
  }
}
```

### 设计模式应用

**常见设计模式实现：**
```javascript
// 单例模式
class DatabaseConnection {
    constructor() {
        if (DatabaseConnection.instance) {
            return DatabaseConnection.instance;
        }
        
        this.connection = null;
        DatabaseConnection.instance = this;
    }
    
    async connect() {
        if (!this.connection) {
            // 实现数据库连接逻辑
            this.connection = await createConnection();
        }
        return this.connection;
    }
    
    static getInstance() {
        if (!DatabaseConnection.instance) {
            DatabaseConnection.instance = new DatabaseConnection();
        }
        return DatabaseConnection.instance;
    }
}

// 工厂模式
class LoggerFactory {
    static createLogger(type) {
        switch (type) {
            case 'console':
                return new ConsoleLogger();
            case 'file':
                return new FileLogger();
            case 'remote':
                return new RemoteLogger();
            default:
                return new ConsoleLogger();
        }
    }
}

class ConsoleLogger {
    log(message) {
        console.log(`[Console] ${message}`);
    }
}

class FileLogger {
    log(message) {
        // 实现文件日志
        console.log(`[File] ${message}`);
    }
}

class RemoteLogger {
    log(message) {
        // 实现远程日志
        console.log(`[Remote] ${message}`);
    }
}

// 观察者模式
class EventEmitter {
    constructor() {
        this.events = {};
    }
    
    on(event, callback) {
        if (!this.events[event]) {
            this.events[event] = [];
        }
        this.events[event].push(callback);
    }
    
    emit(event, data) {
        if (this.events[event]) {
            this.events[event].forEach(callback => callback(data));
        }
    }
    
    off(event, callback) {
        if (this.events[event]) {
            this.events[event] = this.events[event].filter(cb => cb !== callback);
        }
    }
}

// 策略模式
class PaymentProcessor {
    constructor(strategy) {
        this.strategy = strategy;
    }
    
    setStrategy(strategy) {
        this.strategy = strategy;
    }
    
    async processPayment(amount, data) {
        return await this.strategy.process(amount, data);
    }
}

class CreditCardStrategy {
    async process(amount, data) {
        // 信用卡支付逻辑
        console.log(`使用信用卡支付 ${amount}`);
        return { success: true, transactionId: 'cc_' + Date.now() };
    }
}

class PayPalStrategy {
    async process(amount, data) {
        // PayPal 支付逻辑
        console.log(`使用 PayPal 支付 ${amount}`);
        return { success: true, transactionId: 'pp_' + Date.now() };
    }
}

// 装饰器模式
class UserService {
    async getUser(id) {
        // 基础用户获取逻辑
        return { id, name: 'User' + id };
    }
}

function withLogging(target, propertyName, descriptor) {
    const method = descriptor.value;
    
    descriptor.value = async function(...args) {
        console.log(`调用方法 ${propertyName}，参数:`, args);
        const result = await method.apply(this, args);
        console.log(`方法 ${propertyName} 返回:`, result);
        return result;
    };
    
    return descriptor;
}

function withCache(target, propertyName, descriptor) {
    const method = descriptor.value;
    const cache = new Map();
    
    descriptor.value = async function(...args) {
        const key = JSON.stringify(args);
        if (cache.has(key)) {
            console.log(`从缓存获取 ${propertyName}`);
            return cache.get(key);
        }
        
        const result = await method.apply(this, args);
        cache.set(key, result);
        return result;
    };
    
    return descriptor;
}

class EnhancedUserService extends UserService {
    @withLogging
    @withCache
    async getUser(id) {
        return super.getUser(id);
    }
}

// 使用示例
const userService = new EnhancedUserService();
userService.getUser(1); // 会记录日志并缓存
userService.getUser(1); // 从缓存获取
```

### 文档编写规范

**API 文档生成：**
```javascript
// 使用 JSDoc 编写文档
/**
 * 用户服务类
 * 提供用户相关的业务逻辑处理
 * @class UserService
 */
class UserService {
    /**
     * 创建新用户
     * @param {Object} userData - 用户数据
     * @param {string} userData.name - 用户姓名
     * @param {string} userData.email - 用户邮箱
     * @param {string} userData.password - 用户密码
     * @returns {Promise<Object>} 创建的用户对象
     * @throws {Error} 当用户数据验证失败时抛出错误
     * @example
     * const user = await userService.createUser({
     *   name: '张三',
     *   email: 'zhangsan@example.com',
     *   password: 'password123'
     * });
     */
    async createUser(userData) {
        // 实现逻辑
    }

    /**
     * 根据ID获取用户
     * @param {number} id - 用户ID
     * @returns {Promise<Object|null>} 用户对象或null
     * @example
     * const user = await userService.getUserById(1);
     */
    async getUserById(id) {
        // 实现逻辑
    }
}

// 使用 Swagger/OpenAPI 生成文档
/**
 * @swagger
 * components:
 *   schemas:
 *     User:
 *       type: object
 *       required:
 *         - name
 *         - email
 *       properties:
 *         id:
 *           type: integer
 *           description: 用户ID
 *         name:
 *           type: string
 *           description: 用户姓名
 *         email:
 *           type: string
 *           description: 用户邮箱
 *       example:
 *         id: 1
 *         name: 张三
 *         email: zhangsan@example.com
 */

/**
 * @swagger
 * /api/users:
 *   get:
 *     summary: 获取用户列表
 *     tags: [Users]
 *     parameters:
 *       - in: query
 *         name: page
 *         schema:
 *           type: integer
 *         description: 页码
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *         description: 每页数量
 *     responses:
 *       200:
 *         description: 成功获取用户列表
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 data:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/User'
 *                 pagination:
 *                   type: object
 *                   properties:
 *                     page:
 *                       type: integer
 *                     limit:
 *                       type: integer
 *                     total:
 *                       type: integer
 */
app.get('/api/users', async (req, res) => {
    // 实现逻辑
});
```

**项目文档结构：**
```markdown
# 项目名称

## 项目概述
简要描述项目的目标、功能和价值。

## 技术栈
- Node.js
- Express.js
- PostgreSQL
- Redis
- Docker

## 快速开始

### 环境要求
- Node.js >= 16.0.0
- npm >= 8.0.0
- Docker (可选)

### 安装依赖
```bash
npm install
```

### 环境配置
复制 `.env.example` 文件并重命名为 `.env`，然后根据需要修改配置。

### 启动开发服务器
```bash
npm run dev
```