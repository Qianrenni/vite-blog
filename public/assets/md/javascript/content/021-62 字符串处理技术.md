## 6.2 字符串处理技术

### 1. 字符串基本操作

```javascript
// 字符串创建
const str1 = 'Hello';
const str2 = "World";
const str3 = `Template`;
const str4 = new String('Object'); // 不推荐，创建的是String对象

// 字符串长度
const text = 'JavaScript';
console.log(text.length); // 10

// 访问字符
console.log(text[0]); // 'J'
console.log(text.charAt(0)); // 'J'
console.log(text.charCodeAt(0)); // 74 (Unicode值)
console.log(text.codePointAt(0)); // 74 (ES6，支持Unicode码点)

// 字符串不可变性
let greeting = 'Hello';
greeting[0] = 'h'; // 无效操作
console.log(greeting); // 'Hello' - 原字符串不变

// 字符串连接
const firstName = 'John';
const lastName = 'Doe';
const fullName = firstName + ' ' + lastName; // 'John Doe'
const fullName2 = `${firstName} ${lastName}`; // 模板字符串
const fullName3 = firstName.concat(' ', lastName); // 'John Doe'

// 字符串比较
console.log('a' < 'b'); // true
console.log('A' < 'a'); // true (ASCII码比较)
console.log('10' < '2'); // true (字符串比较，不是数值比较)

// localeCompare() - 本地化字符串比较
console.log('ä'.localeCompare('z', 'de')); // -1 (德语中 ä 排在 z 前面)
```

### 2. 字符串搜索和替换

```javascript
const text = 'The quick brown fox jumps over the lazy dog';

// 搜索方法
console.log(text.indexOf('the')); // 32 - 第一次出现的位置（区分大小写）
console.log(text.indexOf('the', 10)); // 32 - 从索引10开始搜索
console.log(text.lastIndexOf('the')); // 32 - 最后一次出现的位置

console.log(text.search('brown')); // 10 - 支持正则表达式
console.log(text.search(/fox/i)); // 16 - 忽略大小写

// 包含检查
console.log(text.includes('quick')); // true
console.log(text.includes('Quick')); // false
console.log(text.includes('quick', 5)); // true - 从索引5开始检查

// 开头和结尾检查
console.log(text.startsWith('The')); // true
console.log(text.startsWith('quick', 4)); // true - 从索引4开始检查
console.log(text.endsWith('dog')); // true
console.log(text.endsWith('lazy', text.length - 4)); // true - 检查前(length-4)个字符

// 正则表达式搜索
const email = 'contact@example.com';
const emailRegex = /\w+@\w+\.\w+/;
console.log(emailRegex.test(email)); // true
console.log(email.match(emailRegex)); // ['contact@example.com']

// matchAll() - ES2020
const text2 = 'Phone: 123-456-7890, Fax: 987-654-3210';
const phoneRegex = /(\d{3})-(\d{3})-(\d{4})/g;
const matches = [...text2.matchAll(phoneRegex)];
console.log(matches[0]); // ['123-456-7890', '123', '456', '7890']

// 替换方法
const sentence = 'The cat sat on the mat';

// 基本替换
console.log(sentence.replace('cat', 'dog')); // 'The dog sat on the mat'
console.log(sentence.replace(/the/gi, 'a')); // 'a cat sat on a mat' (全局替换，忽略大小写)

// 使用函数进行替换
const prices = 'Price: $29.99, Discount: $5.00';
const updatedPrices = prices.replace(/\$(\d+\.\d+)/g, (match, price) => {
    return `$${(parseFloat(price) * 0.9).toFixed(2)}`;
});
console.log(updatedPrices); // 'Price: $26.99, Discount: $4.50'

// replaceAll() - ES2021
const text3 = 'cat and cat and cat';
console.log(text3.replaceAll('cat', 'dog')); // 'dog and dog and dog'

// 提取子字符串
const longText = 'JavaScript is awesome';

console.log(longText.substring(0, 10)); // 'JavaScript'
console.log(longText.substring(11)); // 'is awesome'

console.log(longText.slice(0, 10)); // 'JavaScript'
console.log(longText.slice(-7)); // 'awesome' - 负数表示从末尾开始
console.log(longText.slice(-7, -1)); // 'awesom'

// substr() - 已废弃，但仍可用
console.log(longText.substr(0, 10)); // 'JavaScript'
console.log(longText.substr(11, 2)); // 'is'
```

### 3. 字符串格式化方法

```javascript
// 大小写转换
const text = 'Hello World';

console.log(text.toUpperCase()); // 'HELLO WORLD'
console.log(text.toLowerCase()); // 'hello world'

// ES2015 新增方法
console.log(text.toLocaleUpperCase()); // 'HELLO WORLD' (考虑本地化)
console.log(text.toLocaleLowerCase()); // 'hello world' (考虑本地化)

// 首字母大写函数
function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}
console.log(capitalize('hello')); // 'Hello'

// 去除空白字符
const spacedText = '  Hello World  ';
console.log(spacedText.trim()); // 'Hello World'
console.log(spacedText.trimStart()); // 'Hello World  '
console.log(spacedText.trimEnd()); // '  Hello World'

// padStart() 和 padEnd() - ES2017
const number = '5';
console.log(number.padStart(3, '0')); // '005'
console.log(number.padEnd(3, '0')); // '500'

// 时间格式化示例
function formatTime(hours, minutes, seconds) {
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}
console.log(formatTime(9, 5, 7)); // '09:05:07'

// repeat() - 重复字符串
const dash = '-'.repeat(10);
console.log(dash); // '----------'

const separator = '='.repeat(20);
console.log(separator);

// 字符串分割
const csv = 'apple,banana,orange,grape';
const fruits = csv.split(',');
console.log(fruits); // ['apple', 'banana', 'orange', 'grape']

const sentence = 'The quick brown fox';
const words = sentence.split(' ');
console.log(words); // ['The', 'quick', 'brown', 'fox']

const chars = sentence.split('');
console.log(chars); // ['T', 'h', 'e', ' ', 'q', 'u', 'i', 'c', 'k', ...]

// 限制分割数量
const limited = csv.split(',', 2);
console.log(limited); // ['apple', 'banana']

// 使用正则表达式分割
const text = 'apple123banana456orange';
const parts = text.split(/\d+/);
console.log(parts); // ['apple', 'banana', 'orange']

// 字符串反转
function reverseString(str) {
    return str.split('').reverse().join('');
}
console.log(reverseString('hello')); // 'olleh'

// 字符串统计
function countChar(str, char) {
    return str.split(char).length - 1;
}
console.log(countChar('hello world', 'l')); // 3
```

### 4. 模板字符串特性

```javascript
// 基本模板字符串
const name = 'Alice';
const age = 25;
const greeting = `Hello, ${name}! You are ${age} years old.`;
console.log(greeting); // 'Hello, Alice! You are 25 years old.'

// 表达式插值
const a = 5;
const b = 10;
console.log(`The sum of ${a} and ${b} is ${a + b}.`); // 'The sum of 5 and 10 is 15.'

// 多行字符串
const multiline = `
This is a
multiline
string
`;
console.log(multiline);

// HTML 模板示例
function createUserCard(user) {
    return `
        <div class="user-card">
            <h2>${user.name}</h2>
            <p>Age: ${user.age}</p>
            <p>Email: ${user.email}</p>
        </div>
    `;
}

const user = {
    name: 'John Doe',
    age: 30,
    email: 'john@example.com'
};

console.log(createUserCard(user));

// 嵌套模板字符串
const classes = ['btn', 'btn-primary'];
const button = `
    <button class="${classes.join(' ')}" 
            data-action="${'submit'}">
        ${'Click me'}
    </button>
`;

// 带标签的模板字符串
function highlight(strings, ...values) {
    let result = '';
    strings.forEach((string, i) => {
        result += string;
        if (values[i]) {
            result += `<mark>${values[i]}</mark>`;
        }
    });
    return result;
}

const name2 = 'JavaScript';
const feature = 'template strings';
const message = highlight`Learn ${name2} ${feature} today!`;
console.log(message); // 'Learn <mark>JavaScript</mark> <mark>template strings</mark> today!'

// 实用的标签函数示例
function currency(strings, ...values) {
    let result = '';
    strings.forEach((string, i) => {
        result += string;
        if (values[i] !== undefined) {
            result += `$${values[i].toFixed(2)}`;
        }
    });
    return result;
}

const price1 = 19.99;
const price2 = 5.50;
const total = price1 + price2;
console.log(currency`Item 1: ${price1}, Item 2: ${price2}, Total: ${total}`);
// 'Item 1: $19.99, Item 2: $5.50, Total: $25.49'

// 原始字符串访问
function raw(strings, ...values) {
    console.log('Raw strings:', strings.raw);
    console.log('Cooked strings:', strings);
}

raw`Hello\nWorld`; 
// Raw strings: ['Hello\\nWorld']
// Cooked strings: ['Hello\nWorld']

// 实际应用：SQL 查询构建
function sql(strings, ...values) {
    let query = '';
    strings.forEach((string, i) => {
        query += string;
        if (values[i] !== undefined) {
            // 简单的 SQL 注入防护（实际项目中需要更完善的方案）
            query += `'${values[i].toString().replace(/'/g, "''")}'`;
        }
    });
    return query;
}

const tableName = 'users';
const userId = "1'; DROP TABLE users; --";
const query = sql`SELECT * FROM ${tableName} WHERE id = ${userId}`;
console.log(query); // "SELECT * FROM 'users' WHERE id = '1''; DROP TABLE users; --'"

// 模板字符串性能优化
// 对于重复使用的模板，可以预编译
function createTemplate(template) {
    return function(data) {
        return template.replace(/\${(\w+)}/g, (match, key) => data[key] || match);
    };
}

const userTemplate = createTemplate('Hello, ${name}! You are ${age} years old.');
console.log(userTemplate({name: 'Bob', age: 30})); // 'Hello, Bob! You are 30 years old.'
```