## 11.1 é”™è¯¯ç±»å‹è¯†åˆ«

### 1. JavaScript å†…ç½®é”™è¯¯ç±»å‹

JavaScript æä¾›äº†å¤šç§å†…ç½®çš„é”™è¯¯ç±»å‹ï¼ˆError ç±»å‹ï¼‰ï¼Œå®ƒä»¬éƒ½ç»§æ‰¿è‡ª `Error` æ„é€ å‡½æ•°ã€‚äº†è§£è¿™äº›é”™è¯¯ç±»å‹æœ‰åŠ©äºæˆ‘ä»¬è¯†åˆ«é”™è¯¯æ¥æºå¹¶è¿›è¡Œé’ˆå¯¹æ€§å¤„ç†ã€‚

#### å¸¸è§å†…ç½®é”™è¯¯ç±»å‹ï¼š

| é”™è¯¯ç±»å‹ | è§¦å‘åœºæ™¯ | ç¤ºä¾‹ |
|--------|--------|------|
| `Error` | é€šç”¨é”™è¯¯ç±»å‹ï¼Œé€šå¸¸ç”¨äºè‡ªå®šä¹‰é”™è¯¯ | `throw new Error("å‡ºé”™äº†")` |
| `SyntaxError` | è¯­æ³•é”™è¯¯ï¼Œä»£ç è§£æé˜¶æ®µå‡ºé”™ | `eval('var a = ')` |
| `ReferenceError` | å¼•ç”¨æœªå£°æ˜çš„å˜é‡ | `console.log(x)`ï¼ˆx æœªå®šä¹‰ï¼‰ |
| `TypeError` | ç±»å‹é”™è¯¯ï¼Œè°ƒç”¨å€¼çš„æ–¹æ³•æˆ–å±æ€§æ—¶ç±»å‹ä¸åŒ¹é… | `null.toString()` |
| `RangeError` | æ•°å€¼è¶…å‡ºå…è®¸èŒƒå›´ | `new Array(-1)` |
| `URIError` | URI ç›¸å…³å‡½æ•°ä½¿ç”¨é”™è¯¯ | `decodeURIComponent('%')` |
| `EvalError` | `eval()` ä½¿ç”¨é”™è¯¯ï¼ˆå·²åºŸå¼ƒï¼‰ | â€” |
| `InternalError` | å¼•æ“å†…éƒ¨é”™è¯¯ï¼ˆéæ ‡å‡†ï¼‰ | é€’å½’å¤ªæ·±å¯¼è‡´æ ˆæº¢å‡º |

> ğŸ’¡ æ³¨æ„ï¼š`SyntaxError` é€šå¸¸åœ¨ä»£ç è§£æé˜¶æ®µå‘ç”Ÿï¼Œ**æ— æ³•è¢« `try...catch` æ•è·**ï¼Œå› ä¸ºä»£ç æ ¹æœ¬æ²¡æ‰§è¡Œã€‚

#### ç¤ºä¾‹ï¼šè¯†åˆ«ä¸åŒé”™è¯¯ç±»å‹

```js
try {
    JSON.parse("{ bad json }");
} catch (err) {
    if (err instanceof SyntaxError) {
        console.error("JSON è¯­æ³•é”™è¯¯:", err.message);
    } else {
        console.error("å…¶ä»–é”™è¯¯:", err.message);
    }
}
```

---

### 2. è‡ªå®šä¹‰é”™è¯¯ç±»åˆ›å»º

ä¸ºäº†æ›´æ¸…æ™°åœ°è¡¨è¾¾ä¸šåŠ¡é€»è¾‘ä¸­çš„å¼‚å¸¸æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿ `Error` ç±»åˆ›å»ºè‡ªå®šä¹‰é”™è¯¯ç±»å‹ã€‚

#### åˆ›å»ºè‡ªå®šä¹‰é”™è¯¯ç±»

```js
class ValidationError extends Error {
    constructor(message) {
        super(message); // è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°
        this.name = "ValidationError"; // è®¾ç½®é”™è¯¯åç§°
        this.code = "VALIDATION_ERROR"; // å¯æ‰©å±•å­—æ®µ
    }
}

// ä½¿ç”¨
function validateEmail(email) {
    if (!email.includes("@")) {
        throw new ValidationError("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
    }
}

try {
    validateEmail("not-an-email");
} catch (err) {
    if (err instanceof ValidationError) {
        console.error("éªŒè¯å¤±è´¥:", err.message);
    }
}
```

#### é«˜çº§è‡ªå®šä¹‰é”™è¯¯ï¼ˆå¸¦é¢å¤–ä¿¡æ¯ï¼‰

```js
class ApiError extends Error {
    constructor(status, message, url) {
        super(`${status} ${message} - ${url}`);
        this.name = "ApiError";
        this.status = status;
        this.url = url;
    }
}

// ä½¿ç”¨
throw new ApiError(404, "Not Found", "https://api.example.com/user");
```

> âœ… æœ€ä½³å®è·µï¼š
> - ç»§æ‰¿ `Error`
> - è®¾ç½® `this.name`
> - ä¿ç•™å †æ ˆä¿¡æ¯ï¼ˆç°ä»£ JS å¼•æ“è‡ªåŠ¨å¤„ç†ï¼‰
> - æ·»åŠ ä¸šåŠ¡ç›¸å…³å±æ€§ï¼ˆå¦‚ codeã€status ç­‰ï¼‰

---

### 3. é”™è¯¯å †æ ˆè·Ÿè¸ªï¼ˆStack Traceï¼‰

é”™è¯¯å¯¹è±¡é€šå¸¸åŒ…å« `.stack` å±æ€§ï¼Œæä¾›é”™è¯¯å‘ç”Ÿçš„è°ƒç”¨å †æ ˆä¿¡æ¯ï¼Œå¯¹è°ƒè¯•è‡³å…³é‡è¦ã€‚

#### ç¤ºä¾‹ï¼šæŸ¥çœ‹å †æ ˆ

```js
function inner() {
    throw new Error("å‡ºé”™äº†ï¼");
}

function outer() {
    inner();
}

try {
    outer();
} catch (err) {
    console.log(err.stack);
}
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
Error: å‡ºé”™äº†ï¼
    at inner (script.js:2:11)
    at outer (script.js:5:5)
    at script.js:8:5
```

#### å †æ ˆçš„ä½œç”¨ï¼š

- å®šä½é”™è¯¯å‘ç”Ÿçš„å…·ä½“æ–‡ä»¶å’Œè¡Œå·
- æŸ¥çœ‹å‡½æ•°è°ƒç”¨é“¾
- åœ¨å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä¸­è¾…åŠ©è°ƒè¯•

> âš ï¸ æ³¨æ„ï¼š
> - `stack` å±æ€§æ˜¯éæ ‡å‡†ä½†å¹¿æ³›æ”¯æŒçš„ã€‚
> - ç”Ÿäº§ç¯å¢ƒä¸­å¯è€ƒè™‘éšè—è¯¦ç»†å †æ ˆä»¥é˜²ä¿¡æ¯æ³„éœ²ã€‚

---

### 4. é”™è¯¯ä¿¡æ¯æ ¼å¼åŒ–

ä¸ºäº†ç»Ÿä¸€é”™è¯¯è¾“å‡ºï¼Œæå‡å¯è¯»æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹é”™è¯¯ä¿¡æ¯è¿›è¡Œæ ¼å¼åŒ–å¤„ç†ã€‚

#### æ–¹æ³•ä¸€ï¼šå°è£…é”™è¯¯å¤„ç†å‡½æ•°

```js
function formatError(err) {
    return {
        name: err.name,
        message: err.message,
        stack: err.stack?.split('\n').slice(0, 5), // åªä¿ç•™å‰5è¡Œ
        timestamp: new Date().toISOString(),
        ...(err.code && { code: err.code }),
        ...(err.status && { status: err.status })
    };
}

try {
    throw new ValidationError("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
} catch (err) {
    console.error("æ ¼å¼åŒ–é”™è¯¯:", formatError(err));
}
```

#### æ–¹æ³•äºŒï¼šä½¿ç”¨ `console.error` é…åˆè‡ªå®šä¹‰æ ¼å¼

```js
console.error(`[${new Date().toLocaleString()}] ${err.name}: ${err.message}`);
```

#### æ–¹æ³•ä¸‰ï¼šæ—¥å¿—ç³»ç»Ÿé›†æˆï¼ˆå¦‚ Winstonã€Pinoï¼‰

```js
// ä½¿ç”¨ Winston ç¤ºä¾‹
const logger = require('winston');
logger.error({
    level: 'error',
    message: err.message,
    stack: err.stack,
    meta: { userId: 123 }
});
```

---