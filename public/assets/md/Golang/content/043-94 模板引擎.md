## 9.4 模板引擎

### text/template包

```go
package main

import (
    "os"
    "text/template"
)

type Person struct {
    Name string
    Age  int
    City string
}

func main() {
    // 基本模板
    tmpl := `Hello {{.Name}}! You are {{.Age}} years old and live in {{.City}}.`
    
    t := template.Must(template.New("person").Parse(tmpl))
    
    person := Person{
        Name: "Alice",
        Age:  30,
        City: "New York",
    }
    
    t.Execute(os.Stdout, person)
    
    // 复杂模板
    complexTmpl := `
Name: {{.Name}}
Age: {{.Age}}
{{if gt .Age 18}}Adult{{else}}Minor{{end}}
{{range .Hobbies}}- {{.}}
{{end}}
`
    
    type DetailedPerson struct {
        Name    string
        Age     int
        Hobbies []string
    }
    
    detailedPerson := DetailedPerson{
        Name:    "Bob",
        Age:     25,
        Hobbies: []string{"Reading", "Swimming", "Coding"},
    }
    
    t2 := template.Must(template.New("detailed").Parse(complexTmpl))
    t2.Execute(os.Stdout, detailedPerson)
}
```

### html/template包

```go
package main

import (
    "html/template"
    "os"
)

func main() {
    htmlTmpl := `
<!DOCTYPE html>
<html>
<head>
    <title>{{.Title}}</title>
</head>
<body>
    <h1>{{.Title}}</h1>
    <p>{{.Content}}</p>
    
    <!-- 自动转义 -->
    <p>User input: {{.UserInput}}</p>
    
    <!-- 条件渲染 -->
    {{if .ShowMessage}}
        <div class="message">{{.Message}}</div>
    {{end}}
    
    <!-- 循环渲染 -->
    <ul>
    {{range .Items}}
        <li>{{.}}</li>
    {{end}}
    </ul>
</body>
</html>
`
    
    data := struct {
        Title      string
        Content    template.HTML
        UserInput  string
        ShowMessage bool
        Message    string
        Items      []string
    }{
        Title:       "My Page",
        Content:     template.HTML("<strong>This is bold content</strong>"),
        UserInput:   "<script>alert('XSS')</script>",
        ShowMessage: true,
        Message:     "Hello World",
        Items:       []string{"Item 1", "Item 2", "Item 3"},
    }
    
    t := template.Must(template.New("page").Parse(htmlTmpl))
    t.Execute(os.Stdout, data)
}
```

### 模板语法

```go
// 模板语法示例
const templateSyntax = `
<!-- 变量 -->
{{.Name}}

<!-- 字段访问 -->
{{.User.Name}}
{{.Users.0.Name}}

<!-- 方法调用 -->
{{.GetTitle}}

<!-- 管道操作 -->
{{.Name | upper | repeat 3}}

<!-- 条件语句 -->
{{if .Condition}}
    True branch
{{else if .AnotherCondition}}
    Else if branch
{{else}}
    False branch
{{end}}

<!-- 循环 -->
{{range .Items}}
    <li>{{.}}</li>
{{else}}
    No items
{{end}}

<!-- 变量声明 -->
{{$name := .Name}}
Hello {{$name}}

<!-- with语句 -->
{{with .User}}
    Name: {{.Name}}
    Age: {{.Age}}
{{end}}

<!-- 比较函数 -->
{{if eq .Status "active"}}Active{{end}}
{{if ne .Count 0}}Non-zero{{end}}
{{if lt .Age 18}}Minor{{end}}
{{if le .Age 18}}18 or younger{{end}}
{{if gt .Age 18}}Adult{{end}}
{{if ge .Age 18}}18 or older{{end}}

<!-- 布尔函数 -->
{{if and .Name .Email}}Both present{{end}}
{{if or .Name .Email}}Either present{{end}}
{{if not .Deleted}}Not deleted{{end}}
`

// 自定义函数
func createTemplateWithFuncs() *template.Template {
    funcMap := template.FuncMap{
        "upper": strings.ToUpper,
        "lower": strings.ToLower,
        "repeat": func(s string, count int) string {
            return strings.Repeat(s, count)
        },
        "now": time.Now,
        "add": func(a, b int) int {
            return a + b
        },
    }
    
    return template.Must(template.New("funcs").Funcs(funcMap).Parse(templateSyntax))
}
```

### 模板继承和包含

```go
// 基础模板 (base.html)
const baseTemplate = `
{{define "base"}}
<!DOCTYPE html>
<html>
<head>
    <title>{{template "title" .}}</title>
    {{template "head" .}}
</head>
<body>
    <header>
        {{template "header" .}}
    </header>
    
    <main>
        {{template "content" .}}
    </main>
    
    <footer>
        {{template "footer" .}}
    </footer>
</body>
</html>
{{end}}
`

// 子模板
const childTemplate = `
{{define "title"}}My Website{{end}}

{{define "head"}}
    <link rel="stylesheet" href="/static/css/style.css">
{{end}}

{{define "header"}}
    <nav>
        <a href="/">Home</a>
        <a href="/about">About</a>
        <a href="/contact">Contact</a>
    </nav>
{{end}}

{{define "content"}}
    <h1>Welcome to our website!</h1>
    <p>{{.Message}}</p>
{{end}}

{{define "footer"}}
    <p>&copy; 2023 My Website</p>
{{end}}

{{template "base" .}}
`

// 使用模板继承
func renderInheritedTemplate() {
    tmpl := baseTemplate + childTemplate
    t := template.Must(template.New("page").Parse(tmpl))
    
    data := struct {
        Message string
    }{
        Message: "This is the main content",
    }
    
    t.Execute(os.Stdout, data)
}
```

### 模板缓存

```go
type TemplateCache struct {
    templates map[string]*template.Template
    mu        sync.RWMutex
}

func NewTemplateCache() *TemplateCache {
    return &TemplateCache{
        templates: make(map[string]*template.Template),
    }
}

func (tc *TemplateCache) Get(name string) (*template.Template, error) {
    tc.mu.RLock()
    tmpl, exists := tc.templates[name]
    tc.mu.RUnlock()
    
    if exists {
        return tmpl, nil
    }
    
    return tc.loadTemplate(name)
}

func (tc *TemplateCache) loadTemplate(name string) (*template.Template, error) {
    tc.mu.Lock()
    defer tc.mu.Unlock()
    
    // 双重检查
    if tmpl, exists := tc.templates[name]; exists {
        return tmpl, nil
    }
    
    // 从文件加载
    tmpl, err := template.ParseFiles("templates/" + name + ".html")
    if err != nil {
        return nil, err
    }
    
    tc.templates[name] = tmpl
    return tmpl, nil
}

func (tc *TemplateCache) Reload(name string) error {
    tc.mu.Lock()
    defer tc.mu.Unlock()
    
    tmpl, err := template.ParseFiles("templates/" + name + ".html")
    if err != nil {
        return err
    }
    
    tc.templates[name] = tmpl
    return nil
}

// 模板预加载
func (tc *TemplateCache) Preload(templateNames []string) error {
    for _, name := range templateNames {
        if _, err := tc.loadTemplate(name); err != nil {
            return err
        }
    }
    return nil
}

// 使用示例
var globalTemplateCache = NewTemplateCache()

func renderTemplate(w http.ResponseWriter, name string, data interface{}) error {
    tmpl, err := globalTemplateCache.Get(name)
    if err != nil {
        return err
    }
    
    return tmpl.Execute(w, data)
}
```

### 模板安全

```go
// XSS防护
func secureTemplateExample() {
    const secureTemplate = `
<!DOCTYPE html>
<html>
<body>
    <!-- 自动转义防止XSS -->
    <p>User comment: {{.UserComment}}</p>
    
    <!-- 安全的HTML内容 -->
    <div>{{.SafeHTML}}</div>
    
    <!-- URL转义 -->
    <a href="{{.UserURL}}">Link</a>
    
    <!-- JavaScript转义 -->
    <script>
        var data = {{.JSONData}};
    </script>
</body>
</html>
`
    
    data := struct {
        UserComment string
        SafeHTML    template.HTML
        UserURL     string
        JSONData    template.JS
    }{
        UserComment: `<script>alert('XSS')</script>`,
        SafeHTML:    template.HTML("<strong>Safe HTML</strong>"),
        UserURL:     "javascript:alert('XSS')",
        JSONData:    template.JS(`{"name": "John", "age": 30}`),
    }
    
    t := template.Must(template.New("secure").Parse(secureTemplate))
    t.Execute(os.Stdout, data)
}

// 内容安全策略
func setCSPHeaders(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        w.Header().Set("Content-Security-Policy", 
            "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'")
        next.ServeHTTP(w, r)
    })
}

// 模板沙箱
type SandboxTemplate struct {
    *template.Template
    allowedFuncs map[string]bool
}

func NewSandboxTemplate() *SandboxTemplate {
    return &SandboxTemplate{
        allowedFuncs: map[string]bool{
            "upper": true,
            "lower": true,
            "len":   true,
        },
    }
}

func (st *SandboxTemplate) Funcs(funcMap template.FuncMap) *SandboxTemplate {
    // 验证函数安全性
    for name := range funcMap {
        if !st.allowedFuncs[name] {
            panic("Function not allowed in sandbox: " + name)
        }
    }
    
    st.Template = st.Template.Funcs(funcMap)
    return st
}
```