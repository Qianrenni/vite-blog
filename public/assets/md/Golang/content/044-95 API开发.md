## 9.5 API开发

### RESTful API设计

```go
package main

import (
    "encoding/json"
    "net/http"
    "strconv"
    "time"
    
    "github.com/gorilla/mux"
)

type User struct {
    ID        int       `json:"id"`
    Name      string    `json:"name"`
    Email     string    `json:"email"`
    CreatedAt time.Time `json:"created_at"`
}

type APIResponse struct {
    Success bool        `json:"success"`
    Message string      `json:"message,omitempty"`
    Data    interface{} `json:"data,omitempty"`
    Error   string      `json:"error,omitempty"`
}

type APIError struct {
    Code    int    `json:"code"`
    Message string `json:"message"`
}

// RESTful路由设计
func setupAPIRoutes() *mux.Router {
    r := mux.NewRouter()
    
    // 用户资源
    api := r.PathPrefix("/api/v1").Subrouter()
    
    // 集合操作
    api.HandleFunc("/users", getUsers).Methods("GET")      // 获取用户列表
    api.HandleFunc("/users", createUser).Methods("POST")   // 创建用户
    
    // 单个资源操作
    api.HandleFunc("/users/{id}", getUser).Methods("GET")     // 获取单个用户
    api.HandleFunc("/users/{id}", updateUser).Methods("PUT")  // 更新用户
    api.HandleFunc("/users/{id}", deleteUser).Methods("DELETE") // 删除用户
    
    // 子资源
    api.HandleFunc("/users/{id}/posts", getUserPosts).Methods("GET")
    
    return r
}

func getUsers(w http.ResponseWriter, r *http.Request) {
    // 模拟数据
    users := []User{
        {ID: 1, Name: "Alice", Email: "alice@example.com", CreatedAt: time.Now()},
        {ID: 2, Name: "Bob", Email: "bob@example.com", CreatedAt: time.Now()},
    }
    
    response := APIResponse{
        Success: true,
        Data:    users,
    }
    
    jsonResponse(w, response, http.StatusOK)
}

func getUser(w http.ResponseWriter, r *http.Request) {
    vars := mux.Vars(r)
    id, err := strconv.Atoi(vars["id"])
    if err != nil {
        sendError(w, "Invalid user ID", http.StatusBadRequest)
        return
    }
    
    // 模拟查找用户
    user := User{
        ID:        id,
        Name:      "User " + vars["id"],
        Email:     "user" + vars["id"] + "@example.com",
        CreatedAt: time.Now(),
    }
    
    response := APIResponse{
        Success: true,
        Data:    user,
    }
    
    jsonResponse(w, response, http.StatusOK)
}

func createUser(w http.ResponseWriter, r *http.Request) {
    var user User
    if err := json.NewDecoder(r.Body).Decode(&user); err != nil {
        sendError(w, "Invalid JSON", http.StatusBadRequest)
        return
    }
    
    // 验证数据
    if user.Name == "" || user.Email == "" {
        sendError(w, "Name and email are required", http.StatusBadRequest)
        return
    }
    
    // 模拟创建用户
    user.ID = 123
    user.CreatedAt = time.Now()
    
    response := APIResponse{
        Success: true,
        Message: "User created successfully",
        Data:    user,
    }
    
    jsonResponse(w, response, http.StatusCreated)
}

func updateUser(w http.ResponseWriter, r *http.Request) {
    vars := mux.Vars(r)
    id, _ := strconv.Atoi(vars["id"])
    
    var user User
    if err := json.NewDecoder(r.Body).Decode(&user); err != nil {
        sendError(w, "Invalid JSON", http.StatusBadRequest)
        return
    }
    
    // 模拟更新
    user.ID = id
    user.CreatedAt = time.Now()
    
    response := APIResponse{
        Success: true,
        Message: "User updated successfully",
        Data:    user,
    }
    
    jsonResponse(w, response, http.StatusOK)
}

func deleteUser(w http.ResponseWriter, r *http.Request) {
    vars := mux.Vars(r)
    id := vars["id"]
    
    // 模拟删除
    response := APIResponse{
        Success: true,
        Message: "User " + id + " deleted successfully",
    }
    
    jsonResponse(w, response, http.StatusOK)
}
```

### JSON处理

```go
// 自定义JSON序列化
type CustomUser struct {
    ID        int       `json:"id"`
    Name      string    `json:"name"`
    Email     string    `json:"email"`
    CreatedAt time.Time `json:"created_at"`
    Password  string    `json:"-"` // 不序列化密码
}

// 自定义序列化方法
func (u CustomUser) MarshalJSON() ([]byte, error) {
    type Alias CustomUser
    return json.Marshal(&struct {
        *Alias
        CreatedAt string `json:"created_at"`
    }{
        Alias:     (*Alias)(&u),
        CreatedAt: u.CreatedAt.Format("2006-01-02 15:04:05"),
    })
}

// 自定义反序列化方法
func (u *CustomUser) UnmarshalJSON(data []byte) error {
    type Alias CustomUser
    aux := &struct {
        CreatedAt string `json:"created_at"`
        *Alias
    }{
        Alias: (*Alias)(u),
    }
    
    if err := json.Unmarshal(data, &aux); err != nil {
        return err
    }
    
    var err error
    u.CreatedAt, err = time.Parse("2006-01-02 15:04:05", aux.CreatedAt)
    return err
}

// JSON流处理
func streamJSONResponse(w http.ResponseWriter, data []User) {
    w.Header().Set("Content-Type", "application/json")
    w.WriteHeader(http.StatusOK)
    
    encoder := json.NewEncoder(w)
    encoder.Encode(map[string]interface{}{
        "success": true,
        "data":    data,
    })
}

// JSON验证
type UserInput struct {
    Name  string `json:"name" validate:"required,min=2,max=50"`
    Email string `json:"email" validate:"required,email"`
    Age   int    `json:"age" validate:"min=0,max=150"`
}

func validateJSON(w http.ResponseWriter, r *http.Request) {
    var input UserInput
    decoder := json.NewDecoder(r.Body)
    decoder.DisallowUnknownFields() // 不允许未知字段
    
    if err := decoder.Decode(&input); err != nil {
        sendError(w, "Invalid JSON: "+err.Error(), http.StatusBadRequest)
        return
    }
    
    // 验证数据
    if err := validate.Struct(input); err != nil {
        sendError(w, "Validation failed: "+err.Error(), http.StatusBadRequest)
        return
    }
    
    jsonResponse(w, map[string]interface{}{
        "success": true,
        "data":    input,
    }, http.StatusOK)
}
```

### 请求验证

```go
import (
    "github.com/go-playground/validator/v10"
)

var validate *validator.Validate

func init() {
    validate = validator.New()
}

type UserRegistration struct {
    Name     string `json:"name" validate:"required,min=2,max=50"`
    Email    string `json:"email" validate:"required,email"`
    Password string `json:"password" validate:"required,min=8"`
    Age      int    `json:"age" validate:"min=0,max=150"`
    Website  string `json:"website" validate:"omitempty,url"`
}

func validateRequest(w http.ResponseWriter, r *http.Request) {
    var user UserRegistration
    if err := json.NewDecoder(r.Body).Decode(&user); err != nil {
        sendError(w, "Invalid JSON", http.StatusBadRequest)
        return
    }
    
    if err := validate.Struct(user); err != nil {
        var errors []string
        for _, err := range err.(validator.ValidationErrors) {
            errors = append(errors, err.Error())
        }
        
        jsonResponse(w, map[string]interface{}{
            "success": false,
            "errors":  errors,
        }, http.StatusBadRequest)
        return
    }
    
    jsonResponse(w, map[string]interface{}{
        "success": true,
        "message": "Validation passed",
    }, http.StatusOK)
}

// 自定义验证规则
func init() {
    validate.RegisterValidation("username", validateUsername)
}

func validateUsername(fl validator.FieldLevel) bool {
    username := fl.Field().String()
    // 自定义用户名验证逻辑
    return len(username) >= 3 && len(username) <= 20
}

// 查询参数验证
type UserQuery struct {
    Page     int    `schema:"page" validate:"min=1"`
    Limit    int    `schema:"limit" validate:"min=1,max=100"`
    Sort     string `schema:"sort" validate:"oneof=created_at name email"`
    Order    string `schema:"order" validate:"oneof=asc desc"`
    Search   string `schema:"search"`
}

func validateQueryParams(w http.ResponseWriter, r *http.Request) {
    var query UserQuery
    
    // 默认值
    query.Page = 1
    query.Limit = 10
    query.Sort = "created_at"
    query.Order = "desc"
    
    // 解析查询参数
    decoder := schema.NewDecoder()
    if err := decoder.Decode(&query, r.URL.Query()); err != nil {
        sendError(w, "Invalid query parameters", http.StatusBadRequest)
        return
    }
    
    // 验证
    if err := validate.Struct(query); err != nil {
        sendError(w, "Invalid query parameters: "+err.Error(), http.StatusBadRequest)
        return
    }
    
    // 处理请求
    jsonResponse(w, map[string]interface{}{
        "success": true,
        "query":   query,
    }, http.StatusOK)
}
```

### 分页处理

```go
type Pagination struct {
    Page       int `json:"page"`
    Limit      int `json:"limit"`
    Total      int `json:"total"`
    TotalPages int `json:"total_pages"`
}

type PaginatedResponse struct {
    Data       interface{} `json:"data"`
    Pagination Pagination  `json:"pagination"`
    Success    bool        `json:"success"`
}

func paginate(data []User, page, limit int) PaginatedResponse {
    total := len(data)
    totalPages := (total + limit - 1) / limit
    
    if page > totalPages {
        page = totalPages
    }
    
    if page < 1 {
        page = 1
    }
    
    start := (page - 1) * limit
    end := start + limit
    
    if end > total {
        end = total
    }
    
    var paginatedData []User
    if start < total {
        paginatedData = data[start:end]
    }
    
    return PaginatedResponse{
        Data: paginatedData,
        Pagination: Pagination{
            Page:       page,
            Limit:      limit,
            Total:      total,
            TotalPages: totalPages,
        },
        Success: true,
    }
}

func paginatedUsersHandler(w http.ResponseWriter, r *http.Request) {
    // 解析分页参数
    pageStr := r.URL.Query().Get("page")
    limitStr := r.URL.Query().Get("limit")
    
    page := 1
    limit := 10
    
    if pageStr != "" {
        if p, err := strconv.Atoi(pageStr); err == nil && p > 0 {
            page = p
        }
    }
    
    if limitStr != "" {
        if l, err := strconv.Atoi(limitStr); err == nil && l > 0 && l <= 100 {
            limit = l
        }
    }
    
    // 模拟数据
    var users []User
    for i := 1; i <= 100; i++ {
        users = append(users, User{
            ID:        i,
            Name:      fmt.Sprintf("User %d", i),
            Email:     fmt.Sprintf("user%d@example.com", i),
            CreatedAt: time.Now().Add(-time.Duration(i) * time.Hour),
        })
    }
    
    response := paginate(users, page, limit)
    jsonResponse(w, response, http.StatusOK)
}

// 游标分页
type CursorPagination struct {
    NextCursor string `json:"next_cursor,omitempty"`
    PrevCursor string `json:"prev_cursor,omitempty"`
    Limit      int    `json:"limit"`
    HasMore    bool   `json:"has_more"`
}

type CursorPaginatedResponse struct {
    Data       interface{}      `json:"data"`
    Pagination CursorPagination `json:"pagination"`
    Success    bool             `json:"success"`
}

func cursorPaginate(users []User, cursor string, limit int) CursorPaginatedResponse {
    startIndex := 0
    if cursor != "" {
        // 解析游标，这里简化处理
        if idx, err := strconv.Atoi(cursor); err == nil {
            startIndex = idx
        }
    }
    
    endIndex := startIndex + limit
    hasMore := endIndex < len(users)
    
    var paginatedData []User
    if startIndex < len(users) {
        if endIndex > len(users) {
            endIndex = len(users)
        }
        paginatedData = users[startIndex:endIndex]
    }
    
    var nextCursor string
    if hasMore {
        nextCursor = strconv.Itoa(endIndex)
    }
    
    return CursorPaginatedResponse{
        Data: paginatedData,
        Pagination: CursorPagination{
            NextCursor: nextCursor,
            Limit:      limit,
            HasMore:    hasMore,
        },
        Success: true,
    }
}
```

### 错误响应格式

```go
type ErrorResponse struct {
    Success bool        `json:"success"`
    Error   ErrorDetail `json:"error"`
}

type ErrorDetail struct {
    Code    int         `json:"code"`
    Message string      `json:"message"`
    Details interface{} `json:"details,omitempty"`
}

type ValidationError struct {
    Field   string `json:"field"`
    Message string `json:"message"`
}

func sendError(w http.ResponseWriter, message string, code int) {
    response := ErrorResponse{
        Success: false,
        Error: ErrorDetail{
            Code:    code,
            Message: message,
        },
    }
    
    jsonResponse(w, response, code)
}

func sendValidationError(w http.ResponseWriter, errors []ValidationError) {
    response := ErrorResponse{
        Success: false,
        Error: ErrorDetail{
            Code:    http.StatusBadRequest,
            Message: "Validation failed",
            Details: errors,
        },
    }
    
    jsonResponse(w, response, http.StatusBadRequest)
}

// 错误处理中间件
func errorMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        defer func() {
            if err := recover(); err != nil {
                // 记录错误日志
                log.Printf("Panic recovered: %v", err)
                
                // 发送错误响应
                sendError(w, "Internal server error", http.StatusInternalServerError)
            }
        }()
        
        next.ServeHTTP(w, r)
    })
}

// 自定义错误类型
type APIError struct {
    Code    int
    Message string
    Err     error
}

func (e APIError) Error() string {
    return e.Message
}

func NewAPIError(code int, message string, err error) APIError {
    return APIError{
        Code:    code,
        Message: message,
        Err:     err,
    }
}

func sendAPIError(w http.ResponseWriter, apiErr APIError) {
    response := ErrorResponse{
        Success: false,
        Error: ErrorDetail{
            Code:    apiErr.Code,
            Message: apiErr.Message,
            Details: apiErr.Err,
        },
    }
    
    jsonResponse(w, response, apiErr.Code)
}
```

### API文档生成

```go
// 使用Swagger注解
// @title User API
// @version 1.0
// @description User management API
// @host localhost:8080
// @BasePath /api/v1

// @Summary Get users
// @Description Get a list of users
// @Tags users
// @Accept json
// @Produce json
// @Param page query int false "Page number" default(1)
// @Param limit query int false "Number of items per page" default(10)
// @Success 200 {object} PaginatedResponse
// @Failure 400 {object} ErrorResponse
// @Failure 500 {object} ErrorResponse
// @Router /users [get]
func getUsersHandler(w http.ResponseWriter, r *http.Request) {
    // 实现
}

// @Summary Create user
// @Description Create a new user
// @Tags users
// @Accept json
// @Produce json
// @Param user body UserRegistration true "User data"
// @Success 201 {object} APIResponse
// @Failure 400 {object} ErrorResponse
// @Failure 500 {object} ErrorResponse
// @Router /users [post]
func createUserHandler(w http.ResponseWriter, r *http.Request) {
    // 实现
}

// 文档端点
func docsHandler(w http.ResponseWriter, r *http.Request) {
    html := `
<!DOCTYPE html>
<html>
<head>
    <title>API Documentation</title>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@3/swagger-ui.css">
</head>
<body>
    <div id="swagger-ui"></div>
    <script src="https://unpkg.com/swagger-ui-dist@3/swagger-ui-bundle.js"></script>
    <script>
        SwaggerUIBundle({
            url: '/swagger.json',
            dom_id: '#swagger-ui'
        });
    </script>
</body>
</html>
`
    w.Header().Set("Content-Type", "text/html")
    w.Write([]byte(html))
}

// 生成Swagger JSON
func swaggerHandler(w http.ResponseWriter, r *http.Request) {
    swaggerSpec := map[string]interface{}{
        "swagger": "2.0",
        "info": map[string]interface{}{
            "title":       "User API",
            "version":     "1.0",
            "description": "User management API",
        },
        "host":     "localhost:8080",
        "basePath": "/api/v1",
        "schemes":  []string{"http"},
        "paths": map[string]interface{}{
            "/users": map[string]interface{}{
                "get": map[string]interface{}{
                    "summary":     "Get users",
                    "description": "Get a list of users",
                    "tags":        []string{"users"},
                    "parameters": []map[string]interface{}{
                        {
                            "name":     "page",
                            "in":       "query",
                            "type":     "integer",
                            "default":  1,
                            "required": false,
                        },
                        {
                            "name":     "limit",
                            "in":       "query",
                            "type":     "integer",
                            "default":  10,
                            "required": false,
                        },
                    },
                    "responses": map[string]interface{}{
                        "200": map[string]interface{}{
                            "description": "Success",
                            "schema": map[string]interface{}{
                                "$ref": "#/definitions/PaginatedResponse",
                            },
                        },
                    },
                },
            },
        },
        "definitions": map[string]interface{}{
            "User": map[string]interface{}{
                "type": "object",
                "properties": map[string]interface{}{
                    "id":         map[string]interface{}{"type": "integer"},
                    "name":       map[string]interface{}{"type": "string"},
                    "email":      map[string]interface{}{"type": "string"},
                    "created_at": map[string]interface{}{"type": "string", "format": "date-time"},
                },
            },
        },
    }
    
    w.Header().Set("Content-Type", "application/json")
    json.NewEncoder(w).Encode(swaggerSpec)
}
```

### API版本管理

```go
type APIVersion string

const (
    VersionV1 APIVersion = "v1"
    VersionV2 APIVersion = "v2"
)

func versionMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // 从URL路径提取版本
        version := extractVersion(r.URL.Path)
        
        // 从请求头提取版本
        if version == "" {
            version = APIVersion(r.Header.Get("API-Version"))
        }
        
        // 设置默认版本
        if version == "" {
            version = VersionV1
        }
        
        // 将版本信息添加到请求上下文
        ctx := context.WithValue(r.Context(), "api-version", version)
        next.ServeHTTP(w, r.WithContext(ctx))
    })
}

func extractVersion(path string) APIVersion {
    // 匹配 /api/v1/ 或 /api/v2/
    re := regexp.MustCompile(`/api/(v\d+)/`)
    matches := re.FindStringSubmatch(path)
    if len(matches) > 1 {
        return APIVersion(matches[1])
    }
    return ""
}

// 版本路由
func setupVersionedRoutes() *mux.Router {
    r := mux.NewRouter()
    
    // V1 API
    v1 := r.PathPrefix("/api/v1").Subrouter()
    v1.Use(versionMiddleware)
    v1.HandleFunc("/users", getUsersV1).Methods("GET")
    v1.HandleFunc("/users", createUserV1).Methods("POST")
    
    // V2 API
    v2 := r.PathPrefix("/api/v2").Subrouter()
    v2.Use(versionMiddleware)
    v2.HandleFunc("/users", getUsersV2).Methods("GET")
    v2.HandleFunc("/users", createUserV2).Methods("POST")
    
    return r
}

// V1实现
func getUsersV1(w http.ResponseWriter, r *http.Request) {
    users := []User{
        {ID: 1, Name: "User V1", Email: "user@v1.com"},
    }
    
    response := APIResponse{
        Success: true,
        Data:    users,
    }
    
    jsonResponse(w, response, http.StatusOK)
}

// V2实现
type UserV2 struct {
    ID        int       `json:"id"`
    Name      string    `json:"name"`
    Email     string    `json:"email"`
    Phone     string    `json:"phone"` // 新增字段
    CreatedAt time.Time `json:"created_at"`
}

func getUsersV2(w http.ResponseWriter, r *http.Request) {
    users := []UserV2{
        {ID: 1, Name: "User V2", Email: "user@v2.com", Phone: "+1234567890"},
    }
    
    response := APIResponse{
        Success: true,
        Data:    users,
    }
    
    jsonResponse(w, response, http.StatusOK)
}

// 版本协商
func negotiateVersion(r *http.Request) APIVersion {
    // 检查Accept头
    accept := r.Header.Get("Accept")
    if strings.Contains(accept, "application/vnd.api.v2+json") {
        return VersionV2
    }
    
    // 检查自定义头
    version := r.Header.Get("API-Version")
    switch version {
    case "v2":
        return VersionV2
    default:
        return VersionV1
    }
}
```

### GraphQL集成

```go
import (
    "github.com/graphql-go/graphql"
)

// GraphQL模式定义
var userType = graphql.NewObject(graphql.ObjectConfig{
    Name: "User",
    Fields: graphql.Fields{
        "id": &graphql.Field{
            Type: graphql.Int,
        },
        "name": &graphql.Field{
            Type: graphql.String,
        },
        "email": &graphql.Field{
            Type: graphql.String,
        },
        "created_at": &graphql.Field{
            Type: graphql.String,
        },
    },
})

var queryType = graphql.NewObject(graphql.ObjectConfig{
    Name: "Query",
    Fields: graphql.Fields{
        "user": &graphql.Field{
            Type: userType,
            Args: graphql.FieldConfigArgument{
                "id": &graphql.ArgumentConfig{
                    Type: graphql.Int,
                },
            },
            Resolve: func(p graphql.ResolveParams) (interface{}, error) {
                id, ok := p.Args["id"].(int)
                if ok {
                    // 模拟数据查找
                    return User{
                        ID:        id,
                        Name:      "User " + strconv.Itoa(id),
                        Email:     "user" + strconv.Itoa(id) + "@example.com",
                        CreatedAt: time.Now(),
                    }, nil
                }
                return nil, nil
            },
        },
        "users": &graphql.Field{
            Type: graphql.NewList(userType),
            Args: graphql.FieldConfigArgument{
                "limit": &graphql.ArgumentConfig{
                    Type: graphql.Int,
                },
            },
            Resolve: func(p graphql.ResolveParams) (interface{}, error) {
                limit, _ := p.Args["limit"].(int)
                if limit == 0 {
                    limit = 10
                }
                
                var users []User
                for i := 1; i <= limit; i++ {
                    users = append(users, User{
                        ID:        i,
                        Name:      "User " + strconv.Itoa(i),
                        Email:     "user" + strconv.Itoa(i) + "@example.com",
                        CreatedAt: time.Now(),
                    })
                }
                return users, nil
            },
        },
    },
})

var mutationType = graphql.NewObject(graphql.ObjectConfig{
    Name: "Mutation",
    Fields: graphql.Fields{
        "createUser": &graphql.Field{
            Type: userType,
            Args: graphql.FieldConfigArgument{
                "name": &graphql.ArgumentConfig{
                    Type: graphql.NewNonNull(graphql.String),
                },
                "email": &graphql.ArgumentConfig{
                    Type: graphql.NewNonNull(graphql.String),
                },
            },
            Resolve: func(p graphql.ResolveParams) (interface{}, error) {
                name, _ := p.Args["name"].(string)
                email, _ := p.Args["email"].(string)
                
                // 模拟创建用户
                user := User{
                    ID:        123,
                    Name:      name,
                    Email:     email,
                    CreatedAt: time.Now(),
                }
                return user, nil
            },
        },
    },
})

var schema, _ = graphql.NewSchema(graphql.SchemaConfig{
    Query:    queryType,
    Mutation: mutationType,
})

// GraphQL处理器
func graphqlHandler(w http.ResponseWriter, r *http.Request) {
    // 解析查询
    query := r.URL.Query().Get("query")
    if query == "" {
        body, _ := ioutil.ReadAll(r.Body)
        var params map[string]interface{}
        json.Unmarshal(body, &params)
        query = params["query"].(string)
    }
    
    // 执行查询
    result := graphql.Do(graphql.Params{
        Schema:        schema,
        RequestString: query,
    })
    
    // 返回结果
    w.Header().Set("Content-Type", "application/json")
    json.NewEncoder(w).Encode(result)
}

// GraphQL路由
func setupGraphQLRoutes() *mux.Router {
    r := mux.NewRouter()
    
    // GraphQL端点
    r.HandleFunc("/graphql", graphqlHandler).Methods("GET", "POST")
    
    // GraphQL Playground
    r.HandleFunc("/graphql", playgroundHandler).Methods("GET")
    
    return r
}

func playgroundHandler(w http.ResponseWriter, r *http.Request) {
    html := `
<!DOCTYPE html>
<html>
<head>
    <title>GraphQL Playground</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/graphql-playground-react/build/static/css/index.css" />
</head>
<body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/graphql-playground-react/build/static/js/middleware.js"></script>
    <script>
        window.addEventListener('load', function (event) {
            GraphQLPlayground.init(document.getElementById('root'), {
                endpoint: '/graphql'
            });
        });
    </script>
</body>
</html>
`
    w.Header().Set("Content-Type", "text/html")
    w.Write([]byte(html))
}
```

### 辅助函数

```go
// JSON响应辅助函数
func jsonResponse(w http.ResponseWriter, data interface{}, statusCode int) {
    w.Header().Set("Content-Type", "application/json")
    w.WriteHeader(statusCode)
    json.NewEncoder(w).Encode(data)
}

// CORS中间件
func corsMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        w.Header().Set("Access-Control-Allow-Origin", "*")
        w.Header().Set("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")
        w.Header().Set("Access-Control-Allow-Headers", "Content-Type, Authorization")
        
        if r.Method == "OPTIONS" {
            w.WriteHeader(http.StatusOK)
            return
        }
        
        next.ServeHTTP(w, r)
    })
}

// 认证中间件
func authMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        token := r.Header.Get("Authorization")
        if token == "" {
            sendError(w, "Authorization required", http.StatusUnauthorized)
            return
        }
        
        // 验证token
        if !validateToken(token) {
            sendError(w, "Invalid token", http.StatusUnauthorized)
            return
        }
        
        next.ServeHTTP(w, r)
    })
}

func validateToken(token string) bool {
    // 实现token验证逻辑
    return token == "Bearer valid-token"
}

// 日志中间件
func loggingMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        start := time.Now()
        
        // 包装ResponseWriter以捕获状态码
        wrapped := &responseWriter{ResponseWriter: w, statusCode: http.StatusOK}
        
        next.ServeHTTP(wrapped, r)
        
        log.Printf(
            "%s %s %s %d %v",
            r.RemoteAddr,
            r.Method,
            r.URL.Path,
            wrapped.statusCode,
            time.Since(start),
        )
    })
}

type responseWriter struct {
    http.ResponseWriter
    statusCode int
}

func (rw *responseWriter) WriteHeader(code int) {
    rw.statusCode = code
    rw.ResponseWriter.WriteHeader(code)
}
```