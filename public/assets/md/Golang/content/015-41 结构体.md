## 4.1 结构体

### 结构体定义和初始化

```go
// 定义结构体
type Person struct {
    Name string
    Age  int
    City string
}

// 初始化方式
func main() {
    // 1. 零值初始化
    var p1 Person
    
    // 2. 字面量初始化
    p2 := Person{Name: "Alice", Age: 25, City: "Beijing"}
    
    // 3. 顺序初始化
    p3 := Person{"Bob", 30, "Shanghai"}
    
    // 4. new函数初始化（返回指针）
    p4 := new(Person)
    
    // 5. 取地址初始化
    p5 := &Person{Name: "Charlie", Age: 35}
    
    fmt.Println(p1, p2, p3, p4, p5)
}
```

### 结构体字段访问

```go
type Student struct {
    Name   string
    Age    int
    Grades []int
}

func main() {
    s := Student{
        Name:   "Tom",
        Age:    20,
        Grades: []int{85, 92, 78},
    }
    
    // 直接访问
    fmt.Println(s.Name)        // Tom
    fmt.Println(s.Grades[0])   // 85
    
    // 修改字段
    s.Age = 21
    s.Grades = append(s.Grades, 95)
    
    // 指针访问
    ps := &s
    fmt.Println(ps.Name)       // Tom
    ps.Name = "Jerry"
    fmt.Println(s.Name)        // Jerry
}
```

### 结构体方法定义

```go
type Rectangle struct {
    Width, Height float64
}

// 值接收者方法
func (r Rectangle) Area() float64 {
    return r.Width * r.Height
}

// 指针接收者方法
func (r *Rectangle) Scale(factor float64) {
    r.Width *= factor
    r.Height *= factor
}

// 修改结构体字段的方法必须使用指针接收者
func (r *Rectangle) SetDimensions(width, height float64) {
    r.Width = width
    r.Height = height
}

func main() {
    rect := Rectangle{Width: 10, Height: 5}
    
    fmt.Println("Area:", rect.Area())        // 50
    
    rect.Scale(2)
    fmt.Println("Scaled Area:", rect.Area()) // 200
    
    rect.SetDimensions(3, 4)
    fmt.Println("New Area:", rect.Area())    // 12
}
```

### 嵌套结构体

```go
type Address struct {
    Street string
    City   string
    Zip    string
}

type Employee struct {
    Name    string
    Age     int
    Address Address  // 嵌套结构体
}

func main() {
    emp := Employee{
        Name: "John",
        Age:  30,
        Address: Address{
            Street: "123 Main St",
            City:   "New York",
            Zip:    "10001",
        },
    }
    
    // 访问嵌套字段
    fmt.Println(emp.Address.City)  // New York
    
    // 修改嵌套字段
    emp.Address.Zip = "10002"
    
    // 匿名嵌套
    type Company struct {
        Name    string
        Address // 匿名嵌套
    }
    
    company := Company{
        Name: "Tech Corp",
        Address: Address{
            Street: "456 Tech Ave",
            City:   "San Francisco",
            Zip:    "94105",
        },
    }
    
    // 可以直接访问嵌套字段
    fmt.Println(company.City)  // San Francisco
}
```

### 结构体标签（tag）

```go
import (
    "encoding/json"
    "fmt"
    "reflect"
)

type User struct {
    ID       int    `json:"id" db:"id"`
    Name     string `json:"name" db:"name" validate:"required"`
    Email    string `json:"email" db:"email" validate:"email"`
    Password string `json:"-" db:"password"` // 不序列化到JSON
}

func main() {
    user := User{
        ID:       1,
        Name:     "Alice",
        Email:    "alice@example.com",
        Password: "secret",
    }
    
    // JSON序列化
    jsonData, _ := json.Marshal(user)
    fmt.Println(string(jsonData)) // {"id":1,"name":"Alice","email":"alice@example.com"}
    
    // 获取结构体标签
    userType := reflect.TypeOf(user)
    for i := 0; i < userType.NumField(); i++ {
        field := userType.Field(i)
        fmt.Printf("Field: %s, JSON tag: %s\n", 
            field.Name, field.Tag.Get("json"))
    }
}
```

### 结构体嵌入

```go
// 基础类型
type Animal struct {
    Name string
    Age  int
}

func (a Animal) Speak() string {
    return "Some sound"
}

func (a Animal) Info() string {
    return fmt.Sprintf("%s is %d years old", a.Name, a.Age)
}

// 嵌入Animal到Dog
type Dog struct {
    Animal      // 嵌入
    Breed string
}

func (d Dog) Speak() string {
    return "Woof!"
}

// 嵌入多个类型
type Worker struct {
    Name string
    Age  int
}

func (w Worker) Work() string {
    return "Working..."
}

type Student struct {
    Name   string
    School string
}

func (s Student) Study() string {
    return "Studying..."
}

type WorkingStudent struct {
    Worker   // 嵌入
    Student  // 嵌入
}

func main() {
    dog := Dog{
        Animal: Animal{Name: "Buddy", Age: 3},
        Breed:  "Golden Retriever",
    }
    
    fmt.Println(dog.Info())   // Buddy is 3 years old
    fmt.Println(dog.Speak())  // Woof!
    fmt.Println(dog.Name)     // Buddy
    
    // 解决字段冲突
    ws := WorkingStudent{
        Worker: Worker{Name: "Alice", Age: 20},
        Student: Student{Name: "Alice", School: "MIT"},
    }
    
    // 明确指定使用哪个Name
    fmt.Println(ws.Worker.Name)   // Alice
    fmt.Println(ws.Student.Name)  // Alice
}
```

### 匿名字段

```go
type Person struct {
    string  // 匿名字段
    int     // 匿名字段
}

type Employee struct {
    Person  // 匿名字段
    Salary  float64
}

func main() {
    p := Person{"John", 25}
    fmt.Println(p.string)  // John
    fmt.Println(p.int)     // 25
    
    emp := Employee{
        Person: Person{"Alice", 30},
        Salary: 50000,
    }
    
    fmt.Println(emp.string)  // Alice (提升字段)
    fmt.Println(emp.int)     // 30 (提升字段)
}
```

### 结构体比较

```go
type Point struct {
    X, Y int
}

type ComplexStruct struct {
    Data []int  // 切片不能比较
    P    *Point // 指针可以比较（比较地址）
}

func main() {
    // 可比较的结构体
    p1 := Point{1, 2}
    p2 := Point{1, 2}
    p3 := Point{3, 4}
    
    fmt.Println(p1 == p2)  // true
    fmt.Println(p1 == p3)  // false
    
    // 不可比较的结构体
    cs1 := ComplexStruct{Data: []int{1, 2, 3}}
    cs2 := ComplexStruct{Data: []int{1, 2, 3}}
    
    // 这行会编译错误：invalid operation: cs1 == cs2 (struct containing []int cannot be compared)
    // fmt.Println(cs1 == cs2)
    
    // 使用reflect.DeepEqual进行深度比较
    import "reflect"
    fmt.Println(reflect.DeepEqual(cs1, cs2))  // true
}
```