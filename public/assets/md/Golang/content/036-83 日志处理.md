## 8.3 日志处理

### 标准log包使用

```go
package main

import (
    "log"
    "os"
)

func main() {
    // 基本使用
    log.Println("这是一条普通日志")
    log.Printf("格式化日志: %s", "Hello World")
    
    // 设置日志前缀
    log.SetPrefix("[INFO] ")
    log.Println("带前缀的日志")
    
    // 设置日志标志
    log.SetFlags(log.Ldate | log.Ltime | log.Lshortfile)
    log.Println("带文件行号的日志")
    
    // 自定义Logger
    customLogger := log.New(os.Stdout, "[CUSTOM] ", log.LstdFlags)
    customLogger.Println("自定义Logger")
    
    // 输出到文件
    file, err := os.OpenFile("app.log", os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0666)
    if err != nil {
        log.Fatal("无法打开日志文件:", err)
    }
    defer file.Close()
    
    fileLogger := log.New(file, "[FILE] ", log.LstdFlags)
    fileLogger.Println("写入文件的日志")
}
```

### 第三方日志库（zap、logrus等）

#### Zap 日志库使用

```go
package main

import (
    "go.uber.org/zap"
    "go.uber.org/zap/zapcore"
    "gopkg.in/natefinch/lumberjack.v2"
)

func setupZapLogger() *zap.Logger {
    // 开发环境配置
    config := zap.NewDevelopmentConfig()
    config.EncoderConfig.EncodeLevel = zapcore.CapitalColorLevelEncoder
    logger, _ := config.Build()
    return logger
}

func setupProductionLogger() *zap.Logger {
    // 生产环境配置
    encoderConfig := zapcore.EncoderConfig{
        TimeKey:        "time",
        LevelKey:       "level",
        NameKey:        "logger",
        CallerKey:      "caller",
        MessageKey:     "msg",
        StacktraceKey:  "stacktrace",
        LineEnding:     zapcore.DefaultLineEnding,
        EncodeLevel:    zapcore.LowercaseLevelEncoder,
        EncodeTime:     zapcore.ISO8601TimeEncoder,
        EncodeDuration: zapcore.SecondsDurationEncoder,
        EncodeCaller:   zapcore.ShortCallerEncoder,
    }

    // 日志轮转配置
    writeSyncer := zapcore.AddSync(&lumberjack.Logger{
        Filename:   "./logs/app.log",
        MaxSize:    100, // MB
        MaxAge:     30,  // days
        MaxBackups: 10,
        Compress:   true,
    })

    core := zapcore.NewCore(
        zapcore.NewJSONEncoder(encoderConfig),
        writeSyncer,
        zapcore.DebugLevel,
    )

    return zap.New(core, zap.AddCaller(), zap.Development())
}

func main() {
    logger := setupProductionLogger()
    defer logger.Sync()

    // 基本日志
    logger.Info("应用启动")
    logger.Error("发生错误", zap.String("error", "数据库连接失败"))
    
    // 结构化日志
    logger.Info("用户登录",
        zap.String("user_id", "12345"),
        zap.String("ip", "192.168.1.1"),
        zap.Int("login_count", 5),
    )
    
    // 带调用栈的日志
    logger.Error("严重错误", zap.Error(fmt.Errorf("数据库异常")))
}
```

#### Logrus 日志库使用

```go
package main

import (
    "github.com/sirupsen/logrus"
    "gopkg.in/natefinch/lumberjack.v2"
)

func setupLogrus() *logrus.Logger {
    logger := logrus.New()
    
    // 设置日志级别
    logger.SetLevel(logrus.DebugLevel)
    
    // 设置日志格式
    logger.SetFormatter(&logrus.JSONFormatter{
        TimestampFormat: "2006-01-02 15:04:05",
    })
    
    // 设置输出到文件并轮转
    logger.SetOutput(&lumberjack.Logger{
        Filename:   "./logs/app.log",
        MaxSize:    100,
        MaxAge:     30,
        MaxBackups: 10,
        Compress:   true,
    })
    
    return logger
}

func main() {
    logger := setupLogrus()
    
    // 基本使用
    logger.WithFields(logrus.Fields{
        "user_id": "12345",
        "action":  "login",
    }).Info("用户登录成功")
    
    logger.WithError(fmt.Errorf("数据库连接失败")).Error("数据库错误")
    
    // 链式调用
    logger.WithField("module", "auth").
        WithField("version", "1.0").
        Info("认证模块初始化完成")
}
```

### 日志级别管理

```go
package logging

import (
    "go.uber.org/zap"
    "go.uber.org/zap/zapcore"
)

type Logger struct {
    *zap.Logger
    level zap.AtomicLevel
}

func NewLogger(level string) *Logger {
    atomicLevel := zap.NewAtomicLevel()
    
    switch level {
    case "debug":
        atomicLevel.SetLevel(zap.DebugLevel)
    case "info":
        atomicLevel.SetLevel(zap.InfoLevel)
    case "warn":
        atomicLevel.SetLevel(zap.WarnLevel)
    case "error":
        atomicLevel.SetLevel(zap.ErrorLevel)
    default:
        atomicLevel.SetLevel(zap.InfoLevel)
    }
    
    encoderConfig := zapcore.EncoderConfig{
        TimeKey:        "timestamp",
        LevelKey:       "level",
        NameKey:        "logger",
        CallerKey:      "caller",
        MessageKey:     "msg",
        StacktraceKey:  "stacktrace",
        EncodeLevel:    zapcore.CapitalLevelEncoder,
        EncodeTime:     zapcore.ISO8601TimeEncoder,
        EncodeDuration: zapcore.SecondsDurationEncoder,
        EncodeCaller:   zapcore.ShortCallerEncoder,
    }
    
    core := zapcore.NewCore(
        zapcore.NewJSONEncoder(encoderConfig),
        zapcore.AddSync(os.Stdout),
        atomicLevel,
    )
    
    return &Logger{
        Logger: zap.New(core, zap.AddCaller(), zap.Development()),
        level:  atomicLevel,
    }
}

// 动态调整日志级别
func (l *Logger) SetLevel(level string) {
    switch level {
    case "debug":
        l.level.SetLevel(zap.DebugLevel)
    case "info":
        l.level.SetLevel(zap.InfoLevel)
    case "warn":
        l.level.SetLevel(zap.WarnLevel)
    case "error":
        l.level.SetLevel(zap.ErrorLevel)
    }
}

// 使用示例
func main() {
    logger := NewLogger("info")
    defer logger.Sync()
    
    logger.Debug("调试信息") // 不会输出
    logger.Info("普通信息")  // 会输出
    
    // 运行时调整日志级别
    logger.SetLevel("debug")
    logger.Debug("调试信息") // 现在会输出
}
```

### 日志格式化输出

```go
package main

import (
    "encoding/json"
    "fmt"
    "time"
    "go.uber.org/zap"
    "go.uber.org/zap/zapcore"
)

// 自定义日志格式
type CustomEncoder struct {
    zapcore.Encoder
}

func (e CustomEncoder) Clone() zapcore.Encoder {
    return CustomEncoder{Encoder: e.Encoder.Clone()}
}

func (e CustomEncoder) EncodeEntry(ent zapcore.Entry, fields []zapcore.Field) (*buffer.Buffer, error) {
    buf, err := e.Encoder.EncodeEntry(ent, fields)
    if err != nil {
        return buf, err
    }
    
    // 添加自定义格式
    customFormat := fmt.Sprintf("[%s] %s: %s",
        ent.Time.Format("2006-01-02 15:04:05"),
        ent.Level.CapitalString(),
        ent.Message)
    
    buf.Reset()
    buf.AppendString(customFormat)
    buf.AppendString("\n")
    return buf, nil
}

// 结构化日志示例
func logStructuredData(logger *zap.Logger) {
    // 用户行为日志
    logger.Info("用户行为",
        zap.String("user_id", "12345"),
        zap.String("action", "purchase"),
        zap.Float64("amount", 99.99),
        zap.String("currency", "USD"),
        zap.String("product_id", "P001"),
        zap.String("category", "electronics"),
    )
    
    // 系统性能日志
    logger.Info("系统性能",
        zap.String("component", "database"),
        zap.Duration("response_time", 150*time.Millisecond),
        zap.Int("connection_count", 25),
        zap.Bool("healthy", true),
    )
    
    // 错误日志
    logger.Error("处理请求失败",
        zap.String("request_id", "req-001"),
        zap.String("endpoint", "/api/users"),
        zap.String("method", "POST"),
        zap.Error(fmt.Errorf("数据库超时")),
        zap.Int("retry_count", 3),
    )
}
```

### 日志轮转

```go
package logging

import (
    "go.uber.org/zap"
    "go.uber.org/zap/zapcore"
    "gopkg.in/natefinch/lumberjack.v2"
)

type LogConfig struct {
    Filename   string `json:"filename"`
    MaxSize    int    `json:"max_size"`
    MaxAge     int    `json:"max_age"`
    MaxBackups int    `json:"max_backups"`
    Compress   bool   `json:"compress"`
    Level      string `json:"level"`
}

func NewRotatingLogger(config LogConfig) *zap.Logger {
    lumberjackLogger := &lumberjack.Logger{
        Filename:   config.Filename,
        MaxSize:    config.MaxSize,
        MaxAge:     config.MaxAge,
        MaxBackups: config.MaxBackups,
        Compress:   config.Compress,
    }
    
    // 设置日志级别
    level := zapcore.InfoLevel
    switch config.Level {
    case "debug":
        level = zapcore.DebugLevel
    case "warn":
        level = zapcore.WarnLevel
    case "error":
        level = zapcore.ErrorLevel
    }
    
    encoderConfig := zapcore.EncoderConfig{
        TimeKey:        "timestamp",
        LevelKey:       "level",
        NameKey:        "logger",
        CallerKey:      "caller",
        MessageKey:     "msg",
        StacktraceKey:  "stacktrace",
        EncodeLevel:    zapcore.CapitalLevelEncoder,
        EncodeTime:     zapcore.ISO8601TimeEncoder,
        EncodeDuration: zapcore.SecondsDurationEncoder,
        EncodeCaller:   zapcore.ShortCallerEncoder,
    }
    
    core := zapcore.NewCore(
        zapcore.NewJSONEncoder(encoderConfig),
        zapcore.AddSync(lumberjackLogger),
        level,
    )
    
    return zap.New(core, zap.AddCaller(), zap.Development())
}

// 配置示例
func main() {
    config := LogConfig{
        Filename:   "./logs/app.log",
        MaxSize:    100,  // 100MB
        MaxAge:     30,   // 30天
        MaxBackups: 10,   // 保留10个备份
        Compress:   true, // 压缩旧日志
        Level:      "info",
    }
    
    logger := NewRotatingLogger(config)
    defer logger.Sync()
    
    // 测试日志轮转
    for i := 0; i < 10000; i++ {
        logger.Info("测试日志轮转", zap.Int("iteration", i))
    }
}
```