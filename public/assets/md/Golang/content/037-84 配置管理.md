## 8.4 配置管理

### 配置文件解析（JSON、YAML、TOML）

```go
package config

import (
    "encoding/json"
    "io/ioutil"
    "os"
    "gopkg.in/yaml.v2"
    "github.com/BurntSushi/toml"
)

type DatabaseConfig struct {
    Host     string `json:"host" yaml:"host" toml:"host"`
    Port     int    `json:"port" yaml:"port" toml:"port"`
    Username string `json:"username" yaml:"username" toml:"username"`
    Password string `json:"password" yaml:"password" toml:"password"`
    Database string `json:"database" yaml:"database" toml:"database"`
}

type RedisConfig struct {
    Host     string `json:"host" yaml:"host" toml:"host"`
    Port     int    `json:"port" yaml:"port" toml:"port"`
    Password string `json:"password" yaml:"password" toml:"password"`
    DB       int    `json:"db" yaml:"db" toml:"db"`
}

type AppConfig struct {
    AppName    string         `json:"app_name" yaml:"app_name" toml:"app_name"`
    Port       int            `json:"port" yaml:"port" toml:"port"`
    Debug      bool           `json:"debug" yaml:"debug" toml:"debug"`
    Database   DatabaseConfig `json:"database" yaml:"database" toml:"database"`
    Redis      RedisConfig    `json:"redis" yaml:"redis" toml:"redis"`
}

// JSON 配置解析
func LoadJSONConfig(filename string) (*AppConfig, error) {
    data, err := ioutil.ReadFile(filename)
    if err != nil {
        return nil, err
    }
    
    var config AppConfig
    err = json.Unmarshal(data, &config)
    if err != nil {
        return nil, err
    }
    
    return &config, nil
}

// YAML 配置解析
func LoadYAMLConfig(filename string) (*AppConfig, error) {
    data, err := ioutil.ReadFile(filename)
    if err != nil {
        return nil, err
    }
    
    var config AppConfig
    err = yaml.Unmarshal(data, &config)
    if err != nil {
        return nil, err
    }
    
    return &config, nil
}

// TOML 配置解析
func LoadTOMLConfig(filename string) (*AppConfig, error) {
    data, err := ioutil.ReadFile(filename)
    if err != nil {
        return nil, err
    }
    
    var config AppConfig
    _, err = toml.Decode(string(data), &config)
    if err != nil {
        return nil, err
    }
    
    return &config, nil
}

// 配置文件示例
const jsonConfig = `{
    "app_name": "MyApp",
    "port": 8080,
    "debug": true,
    "database": {
        "host": "localhost",
        "port": 5432,
        "username": "postgres",
        "password": "password",
        "database": "myapp"
    },
    "redis": {
        "host": "localhost",
        "port": 6379,
        "password": "",
        "db": 0
    }
}`

const yamlConfig = `
app_name: MyApp
port: 8080
debug: true
database:
  host: localhost
  port: 5432
  username: postgres
  password: password
  database: myapp
redis:
  host: localhost
  port: 6379
  password: ""
  db: 0
`

const tomlConfig = `
app_name = "MyApp"
port = 8080
debug = true

[database]
host = "localhost"
port = 5432
username = "postgres"
password = "password"
database = "myapp"

[redis]
host = "localhost"
port = 6379
password = ""
db = 0
`
```

### 环境变量管理

```go
package config

import (
    "os"
    "strconv"
    "strings"
)

type EnvConfig struct {
    AppConfig
}

func LoadEnvConfig() *EnvConfig {
    config := &EnvConfig{
        AppConfig: AppConfig{
            AppName: getEnv("APP_NAME", "MyApp"),
            Port:    getEnvInt("PORT", 8080),
            Debug:   getEnvBool("DEBUG", false),
            Database: DatabaseConfig{
                Host:     getEnv("DB_HOST", "localhost"),
                Port:     getEnvInt("DB_PORT", 5432),
                Username: getEnv("DB_USERNAME", "postgres"),
                Password: getEnv("DB_PASSWORD", ""),
                Database: getEnv("DB_NAME", "myapp"),
            },
            Redis: RedisConfig{
                Host:     getEnv("REDIS_HOST", "localhost"),
                Port:     getEnvInt("REDIS_PORT", 6379),
                Password: getEnv("REDIS_PASSWORD", ""),
                DB:       getEnvInt("REDIS_DB", 0),
            },
        },
    }
    
    return config
}

// 辅助函数
func getEnv(key, defaultValue string) string {
    if value := os.Getenv(key); value != "" {
        return value
    }
    return defaultValue
}

func getEnvInt(key string, defaultValue int) int {
    if value := os.Getenv(key); value != "" {
        if intValue, err := strconv.Atoi(value); err == nil {
            return intValue
        }
    }
    return defaultValue
}

func getEnvBool(key string, defaultValue bool) bool {
    if value := os.Getenv(key); value != "" {
        return strings.ToLower(value) == "true"
    }
    return defaultValue
}

// 使用示例
func main() {
    // 设置环境变量
    os.Setenv("APP_NAME", "ProductionApp")
    os.Setenv("PORT", "9000")
    os.Setenv("DEBUG", "false")
    
    config := LoadEnvConfig()
    fmt.Printf("App: %s, Port: %d, Debug: %t\n",
        config.AppName, config.Port, config.Debug)
}
```

### 命令行参数解析

```go
package main

import (
    "flag"
    "fmt"
    "os"
    "github.com/spf13/cobra"
    "github.com/spf13/viper"
)

// 使用标准flag包
func parseFlagConfig() {
    var (
        port     = flag.Int("port", 8080, "Server port")
        host     = flag.String("host", "localhost", "Server host")
        config   = flag.String("config", "", "Config file path")
        debug    = flag.Bool("debug", false, "Debug mode")
        logLevel = flag.String("log-level", "info", "Log level")
    )
    
    flag.Parse()
    
    fmt.Printf("Port: %d, Host: %s, Debug: %t, LogLevel: %s\n",
        *port, *host, *debug, *logLevel)
    
    if *config != "" {
        fmt.Printf("Config file: %s\n", *config)
    }
}

// 使用Cobra命令行库
func NewRootCommand() *cobra.Command {
    var cfgFile string
    
    rootCmd := &cobra.Command{
        Use:   "myapp",
        Short: "My application",
        Long:  "A longer description of my application",
        Run: func(cmd *cobra.Command, args []string) {
            // 应用启动逻辑
            fmt.Println("Application started")
        },
    }
    
    // 持久标志
    rootCmd.PersistentFlags().StringVar(&cfgFile, "config", "", "config file (default is $HOME/.myapp.yaml)")
    rootCmd.PersistentFlags().Bool("debug", false, "debug mode")
    rootCmd.PersistentFlags().String("log-level", "info", "log level")
    
    // 本地标志
    rootCmd.Flags().Int("port", 8080, "server port")
    rootCmd.Flags().String("host", "localhost", "server host")
    
    // 绑定到viper
    viper.BindPFlag("port", rootCmd.Flags().Lookup("port"))
    viper.BindPFlag("host", rootCmd.Flags().Lookup("host"))
    viper.BindPFlag("debug", rootCmd.PersistentFlags().Lookup("debug"))
    
    return rootCmd
}

func main() {
    // 标准flag方式
    fmt.Println("=== Flag Config ===")
    parseFlagConfig()
    
    // Cobra方式
    fmt.Println("=== Cobra Config ===")
    rootCmd := NewRootCommand()
    if err := rootCmd.Execute(); err != nil {
        fmt.Println(err)
        os.Exit(1)
    }
}
```

### 配置热更新

```go
package config

import (
    "context"
    "encoding/json"
    "fmt"
    "io/ioutil"
    "sync"
    "time"
    "github.com/fsnotify/fsnotify"
)

type ConfigManager struct {
    mu       sync.RWMutex
    config   *AppConfig
    watchers []ConfigWatcher
    watcher  *fsnotify.Watcher
}

type ConfigWatcher interface {
    OnConfigChange(*AppConfig)
}

func NewConfigManager(configPath string) (*ConfigManager, error) {
    cm := &ConfigManager{}
    
    // 加载初始配置
    config, err := LoadJSONConfig(configPath)
    if err != nil {
        return nil, err
    }
    cm.config = config
    
    // 监听配置文件变化
    err = cm.watchConfigFile(configPath)
    if err != nil {
        return nil, err
    }
    
    return cm, nil
}

func (cm *ConfigManager) watchConfigFile(configPath string) error {
    watcher, err := fsnotify.NewWatcher()
    if err != nil {
        return err
    }
    cm.watcher = watcher
    
    // 监听文件
    err = watcher.Add(configPath)
    if err != nil {
        return err
    }
    
    // 启动监听goroutine
    go cm.watchLoop(configPath)
    
    return nil
}

func (cm *ConfigManager) watchLoop(configPath string) {
    for {
        select {
        case event, ok := <-cm.watcher.Events:
            if !ok {
                return
            }
            if event.Op&fsnotify.Write == fsnotify.Write {
                cm.reloadConfig(configPath)
            }
        case err, ok := <-cm.watcher.Errors:
            if !ok {
                return
            }
            fmt.Printf("配置文件监听错误: %v\n", err)
        }
    }
}

func (cm *ConfigManager) reloadConfig(configPath string) {
    config, err := LoadJSONConfig(configPath)
    if err != nil {
        fmt.Printf("重新加载配置失败: %v\n", err)
        return
    }
    
    cm.mu.Lock()
    oldConfig := cm.config
    cm.config = config
    cm.mu.Unlock()
    
    // 通知观察者
    cm.notifyWatchers(config, oldConfig)
    
    fmt.Println("配置已重新加载")
}

func (cm *ConfigManager) notifyWatchers(newConfig, oldConfig *AppConfig) {
    cm.mu.RLock()
    watchers := make([]ConfigWatcher, len(cm.watchers))
    copy(watchers, cm.watchers)
    cm.mu.RUnlock()
    
    for _, watcher := range watchers {
        watcher.OnConfigChange(newConfig)
    }
}

func (cm *ConfigManager) GetConfig() *AppConfig {
    cm.mu.RLock()
    defer cm.mu.RUnlock()
    return cm.config
}

func (cm *ConfigManager) AddWatcher(watcher ConfigWatcher) {
    cm.mu.Lock()
    defer cm.mu.Unlock()
    cm.watchers = append(cm.watchers, watcher)
}

func (cm *ConfigManager) RemoveWatcher(watcher ConfigWatcher) {
    cm.mu.Lock()
    defer cm.mu.Unlock()
    
    for i, w := range cm.watchers {
        if w == watcher {
            cm.watchers = append(cm.watchers[:i], cm.watchers[i+1:]...)
            break
        }
    }
}

// 配置观察者示例
type DatabaseWatcher struct{}

func (dw *DatabaseWatcher) OnConfigChange(config *AppConfig) {
    fmt.Printf("数据库配置变更: %s:%d\n", config.Database.Host, config.Database.Port)
}

// 使用示例
func main() {
    // 创建配置管理器
    cm, err := NewConfigManager("./config.json")
    if err != nil {
        panic(err)
    }
    
    // 添加观察者
    cm.AddWatcher(&DatabaseWatcher{})
    
    // 获取当前配置
    config := cm.GetConfig()
    fmt.Printf("当前端口: %d\n", config.Port)
    
    // 模拟配置热更新
    go func() {
        time.Sleep(5 * time.Second)
        
        // 修改配置文件
        newConfig := *config
        newConfig.Port = 9000
        
        data, _ := json.MarshalIndent(newConfig, "", "  ")
        ioutil.WriteFile("./config.json", data, 0644)
    }()
    
    // 保持程序运行
    select {}
}
```