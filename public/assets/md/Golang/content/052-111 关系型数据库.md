## 11.1 关系型数据库

### SQL基础

#### 基本概念
```go
// Go语言中的SQL操作
package main

import (
    "database/sql"
    "fmt"
    "log"
    _ "github.com/go-sql-driver/mysql"
)

// 用户结构体
type User struct {
    ID    int    `json:"id"`
    Name  string `json:"name"`
    Email string `json:"email"`
    Age   int    `json:"age"`
}

func main() {
    // 连接数据库
    db, err := sql.Open("mysql", "user:password@tcp(localhost:3306)/dbname")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // 测试连接
    if err := db.Ping(); err != nil {
        log.Fatal(err)
    }

    // 插入数据
    insertUser(db, "张三", "zhangsan@example.com", 25)
    
    // 查询单个用户
    user := getUserByID(db, 1)
    fmt.Printf("用户: %+v\n", user)
    
    // 查询所有用户
    users := getAllUsers(db)
    fmt.Printf("所有用户: %+v\n", users)
    
    // 更新用户
    updateUser(db, 1, "李四", "lisi@example.com", 26)
    
    // 删除用户
    deleteUser(db, 1)
}

// 插入用户
func insertUser(db *sql.DB, name, email string, age int) {
    query := "INSERT INTO users (name, email, age) VALUES (?, ?, ?)"
    result, err := db.Exec(query, name, email, age)
    if err != nil {
        log.Fatal(err)
    }
    
    id, _ := result.LastInsertId()
    fmt.Printf("插入用户ID: %d\n", id)
}

// 根据ID查询用户
func getUserByID(db *sql.DB, id int) User {
    var user User
    query := "SELECT id, name, email, age FROM users WHERE id = ?"
    
    err := db.QueryRow(query, id).Scan(&user.ID, &user.Name, &user.Email, &user.Age)
    if err != nil {
        log.Fatal(err)
    }
    
    return user
}

// 查询所有用户
func getAllUsers(db *sql.DB) []User {
    query := "SELECT id, name, email, age FROM users"
    rows, err := db.Query(query)
    if err != nil {
        log.Fatal(err)
    }
    defer rows.Close()
    
    var users []User
    for rows.Next() {
        var user User
        err := rows.Scan(&user.ID, &user.Name, &user.Email, &user.Age)
        if err != nil {
            log.Fatal(err)
        }
        users = append(users, user)
    }
    
    return users
}

// 更新用户
func updateUser(db *sql.DB, id int, name, email string, age int) {
    query := "UPDATE users SET name = ?, email = ?, age = ? WHERE id = ?"
    _, err := db.Exec(query, name, email, age, id)
    if err != nil {
        log.Fatal(err)
    }
    fmt.Printf("更新用户ID: %d\n", id)
}

// 删除用户
func deleteUser(db *sql.DB, id int) {
    query := "DELETE FROM users WHERE id = ?"
    _, err := db.Exec(query, id)
    if err != nil {
        log.Fatal(err)
    }
    fmt.Printf("删除用户ID: %d\n", id)
}
```

#### 高级SQL操作
```go
// 复杂查询示例
func advancedQueries(db *sql.DB) {
    // 聚合查询
    var count int
    err := db.QueryRow("SELECT COUNT(*) FROM users WHERE age > ?", 18).Scan(&count)
    if err != nil {
        log.Fatal(err)
    }
    fmt.Printf("成年用户数: %d\n", count)
    
    // 分页查询
    page := 1
    pageSize := 10
    offset := (page - 1) * pageSize
    
    rows, err := db.Query(
        "SELECT id, name, email FROM users ORDER BY id LIMIT ? OFFSET ?", 
        pageSize, offset,
    )
    if err != nil {
        log.Fatal(err)
    }
    defer rows.Close()
    
    // JOIN查询
    query := `
        SELECT u.name, o.total 
        FROM users u 
        JOIN orders o ON u.id = o.user_id 
        WHERE u.age > ?
    `
    rows, err = db.Query(query, 18)
    if err != nil {
        log.Fatal(err)
    }
    defer rows.Close()
}
```

### GORM ORM框架

#### 基本使用
```go
package main

import (
    "gorm.io/driver/mysql"
    "gorm.io/gorm"
    "time"
)

// 用户模型
type User struct {
    ID        uint           `gorm:"primaryKey" json:"id"`
    CreatedAt time.Time      `json:"created_at"`
    UpdatedAt time.Time      `json:"updated_at"`
    DeletedAt gorm.DeletedAt `gorm:"index" json:"deleted_at,omitempty"`
    
    Name   string `gorm:"size:100;not null" json:"name"`
    Email  string `gorm:"uniqueIndex;size:100" json:"email"`
    Age    int    `gorm:"check:age > 0" json:"age"`
    Active bool   `gorm:"default:true" json:"active"`
}

// 订单模型
type Order struct {
    ID     uint   `gorm:"primaryKey" json:"id"`
    UserID uint   `json:"user_id"`
    Total  float64 `json:"total"`
    
    // 关联
    User User `gorm:"foreignKey:UserID" json:"user"`
}

func main() {
    // 连接数据库
    dsn := "user:password@tcp(localhost:3306)/dbname?charset=utf8mb4&parseTime=True&loc=Local"
    db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
    if err != nil {
        panic("failed to connect database")
    }

    // 自动迁移
    db.AutoMigrate(&User{}, &Order{})

    // 创建用户
    createUser(db)
    
    // 查询用户
    queryUsers(db)
    
    // 更新用户
    updateUser(db)
    
    // 删除用户
    deleteUser(db)
}

func createUser(db *gorm.DB) {
    user := User{
        Name:  "张三",
        Email: "zhangsan@example.com",
        Age:   25,
    }
    
    result := db.Create(&user)
    if result.Error != nil {
        panic(result.Error)
    }
    
    fmt.Printf("创建用户ID: %d\n", user.ID)
}

func queryUsers(db *gorm.DB) {
    var users []User
    
    // 基本查询
    db.Find(&users)
    fmt.Printf("所有用户: %+v\n", users)
    
    // 条件查询
    var user User
    db.Where("age > ?", 18).First(&user)
    fmt.Printf("年龄大于18的用户: %+v\n", user)
    
    // 指定字段查询
    db.Select("name, email").Where("active = ?", true).Find(&users)
    
    // 排序和限制
    db.Order("created_at desc").Limit(10).Find(&users)
}

func updateUser(db *gorm.DB) {
    // 更新单个字段
    db.Model(&User{}).Where("id = ?", 1).Update("name", "李四")
    
    // 更新多个字段
    db.Model(&User{}).Where("id = ?", 1).Updates(User{Name: "王五", Age: 30})
    
    // 批量更新
    db.Model(&User{}).Where("age < ?", 18).Update("active", false)
}

func deleteUser(db *gorm.DB) {
    // 软删除
    db.Delete(&User{}, 1)
    
    // 永久删除
    db.Unscoped().Delete(&User{}, 2)
}
```

#### 高级GORM特性
```go
// 预加载和关联查询
func advancedGORM(db *gorm.DB) {
    // 预加载关联
    var users []User
    db.Preload("Orders").Find(&users)
    
    // 嵌套预加载
    var orders []Order
    db.Preload("User.Orders").Find(&orders)
    
    // 条件预加载
    db.Preload("Orders", "total > ?", 100).Find(&users)
    
    // 事务处理
    db.Transaction(func(tx *gorm.DB) error {
        // 创建用户
        user := User{Name: "新用户", Email: "new@example.com", Age: 25}
        if err := tx.Create(&user).Error; err != nil {
            return err
        }
        
        // 创建订单
        order := Order{UserID: user.ID, Total: 99.99}
        if err := tx.Create(&order).Error; err != nil {
            return err
        }
        
        return nil
    })
}

// 自定义查询
func customQueries(db *gorm.DB) {
    // 原生SQL查询
    var users []User
    db.Raw("SELECT * FROM users WHERE age > ?", 18).Scan(&users)
    
    // 命名参数
    db.Raw("SELECT * FROM users WHERE name = @name AND age > @age", 
           map[string]interface{}{"name": "张三", "age": 18}).Scan(&users)
    
    // 子查询
    db.Where("age > (?)", db.Table("users").Select("AVG(age)")).Find(&users)
}
```

### 数据库连接池

#### 连接池配置
```go
package main

import (
    "database/sql"
    "fmt"
    "log"
    "time"
    
    _ "github.com/go-sql-driver/mysql"
    "gorm.io/driver/mysql"
    "gorm.io/gorm"
)

func configureConnectionPool() {
    // 原生SQL连接池配置
    db, err := sql.Open("mysql", "user:password@tcp(localhost:3306)/dbname")
    if err != nil {
        log.Fatal(err)
    }
    
    // 设置最大连接数
    db.SetMaxOpenConns(25)
    
    // 设置最大空闲连接数
    db.SetMaxIdleConns(25)
    
    // 设置连接的最大生命周期
    db.SetConnMaxLifetime(5 * time.Minute)
    
    // 设置空闲连接的最大生命周期
    db.SetConnMaxIdleTime(5 * time.Minute)
    
    fmt.Println("连接池配置完成")
}

func gormConnectionPool() {
    dsn := "user:password@tcp(localhost:3306)/dbname?charset=utf8mb4&parseTime=True&loc=Local"
    db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
    if err != nil {
        panic("failed to connect database")
    }
    
    // 获取底层sql.DB对象
    sqlDB, err := db.DB()
    if err != nil {
        panic("failed to get sql.DB")
    }
    
    // 配置连接池
    sqlDB.SetMaxIdleConns(10)
    sqlDB.SetMaxOpenConns(100)
    sqlDB.SetConnMaxLifetime(time.Hour)
    
    fmt.Println("GORM连接池配置完成")
}
```

#### 连接池监控
```go
// 连接池状态监控
func monitorConnectionPool(db *sql.DB) {
    // 定期打印连接池状态
    ticker := time.NewTicker(10 * time.Second)
    defer ticker.Stop()
    
    for range ticker.C {
        stats := db.Stats()
        fmt.Printf("连接池状态:\n")
        fmt.Printf("  最大打开连接数: %d\n", stats.MaxOpenConnections)
        fmt.Printf("  当前打开连接数: %d\n", stats.OpenConnections)
        fmt.Printf("  当前使用连接数: %d\n", stats.InUse)
        fmt.Printf("  当前空闲连接数: %d\n", stats.Idle)
        fmt.Printf("  等待连接数: %d\n", stats.WaitCount)
        fmt.Printf("  等待时间: %v\n", stats.WaitDuration)
        fmt.Println("---")
    }
}
```

### 事务管理

#### 基本事务操作
```go
// 原生SQL事务
func nativeTransaction(db *sql.DB) error {
    // 开始事务
    tx, err := db.Begin()
    if err != nil {
        return err
    }
    
    // 确保事务被正确处理
    defer func() {
        if err != nil {
            tx.Rollback()
            return
        }
        err = tx.Commit()
    }()
    
    // 执行多个操作
    _, err = tx.Exec("INSERT INTO users (name, email) VALUES (?, ?)", "用户1", "user1@example.com")
    if err != nil {
        return err
    }
    
    _, err = tx.Exec("INSERT INTO orders (user_id, total) VALUES (?, ?)", 1, 99.99)
    if err != nil {
        return err
    }
    
    return nil
}

// GORM事务
func gormTransaction(db *gorm.DB) error {
    return db.Transaction(func(tx *gorm.DB) error {
        // 创建用户
        user := User{Name: "新用户", Email: "new@example.com", Age: 25}
        if err := tx.Create(&user).Error; err != nil {
            return err // 回滚事务
        }
        
        // 创建订单
        order := Order{UserID: user.ID, Total: 99.99}
        if err := tx.Create(&order).Error; err != nil {
            return err // 回滚事务
        }
        
        // 模拟错误
        // return errors.New("模拟错误")
        
        return nil // 提交事务
    })
}

// 手动事务控制
func manualTransaction(db *gorm.DB) {
    // 开始事务
    tx := db.Begin()
    
    // 执行操作
    if err := tx.Create(&User{Name: "用户1", Email: "user1@example.com"}).Error; err != nil {
        tx.Rollback()
        return
    }
    
    if err := tx.Create(&Order{UserID: 1, Total: 99.99}).Error; err != nil {
        tx.Rollback()
        return
    }
    
    // 提交事务
    tx.Commit()
}
```

#### 嵌套事务
```go
// 嵌套事务示例
func nestedTransaction(db *gorm.DB) error {
    return db.Transaction(func(tx *gorm.DB) error {
        // 外层事务操作
        if err := tx.Create(&User{Name: "外层用户", Email: "outer@example.com"}).Error; err != nil {
            return err
        }
        
        // 嵌套事务
        return tx.Transaction(func(subTx *gorm.DB) error {
            // 内层事务操作
            if err := subTx.Create(&Order{UserID: 1, Total: 199.99}).Error; err != nil {
                return err // 只回滚内层事务
            }
            return nil
        })
    })
}
```

### 数据库迁移

#### GORM自动迁移
```go
// 自动迁移示例
func autoMigrate(db *gorm.DB) {
    // 自动迁移模型
    err := db.AutoMigrate(&User{}, &Order{})
    if err != nil {
        panic("自动迁移失败")
    }
    
    fmt.Println("自动迁移完成")
}

// 自定义迁移
func customMigration(db *gorm.DB) {
    // 添加列
    db.Migrator().AddColumn(&User{}, "avatar")
    
    // 删除列
    db.Migrator().DropColumn(&User{}, "avatar")
    
    // 修改列
    db.Migrator().AlterColumn(&User{}, "name")
    
    // 添加索引
    db.Migrator().CreateIndex(&User{}, "idx_email")
    
    // 删除索引
    db.Migrator().DropIndex(&User{}, "idx_email")
    
    // 检查表是否存在
    if db.Migrator().HasTable(&User{}) {
        fmt.Println("用户表存在")
    }
    
    // 检查列是否存在
    if db.Migrator().HasColumn(&User{}, "email") {
        fmt.Println("email列存在")
    }
}
```

#### 迁移工具
```go
// 使用migrate工具
package main

import (
    "github.com/golang-migrate/migrate/v4"
    _ "github.com/golang-migrate/migrate/v4/database/mysql"
    _ "github.com/golang-migrate/migrate/v4/source/file"
)

func runMigration() {
    m, err := migrate.New(
        "file://migrations",
        "mysql://user:password@tcp(localhost:3306)/dbname",
    )
    if err != nil {
        panic(err)
    }
    
    // 执行迁移
    if err := m.Up(); err != nil && err != migrate.ErrNoChange {
        panic(err)
    }
    
    fmt.Println("迁移完成")
}
```

### 查询优化

#### 索引优化
```go
// 索引定义
type Product struct {
    ID          uint   `gorm:"primaryKey"`
    Name        string `gorm:"index"`                    // 普通索引
    Category    string `gorm:"index:idx_category_brand"` // 复合索引
    Brand       string `gorm:"index:idx_category_brand"` // 复合索引
    Price       float64
    SKU         string `gorm:"uniqueIndex"`              // 唯一索引
    CreatedAt   time.Time
    UpdatedAt   time.Time
}

// 查询优化示例
func optimizedQueries(db *gorm.DB) {
    var products []Product
    
    // 使用索引的查询
    db.Where("name = ?", "iPhone").Find(&products)
    
    // 复合索引查询
    db.Where("category = ? AND brand = ?", "手机", "Apple").Find(&products)
    
    // 避免全表扫描
    db.Where("sku = ?", "ABC123").First(&products)
    
    // 使用EXPLAIN分析查询
    db.Debug().Where("name LIKE ?", "%iPhone%").Find(&products)
}
```

#### 查询性能优化
```go
// 性能优化技巧
func performanceOptimization(db *gorm.DB) {
    var users []User
    
    // 1. 选择特定字段
    db.Select("id, name, email").Find(&users)
    
    // 2. 预加载减少N+1查询
    var orders []Order
    db.Preload("User").Find(&orders)
    
    // 3. 批量查询
    db.Where("id IN ?", []int{1, 2, 3, 4, 5}).Find(&users)
    
    // 4. 分页查询
    page := 1
    pageSize := 20
    db.Offset((page-1)*pageSize).Limit(pageSize).Find(&users)
    
    // 5. 使用索引提示
    db.Clauses(hints.UseIndex("idx_email")).Where("email = ?", "test@example.com").Find(&users)
}
```